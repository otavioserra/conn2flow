````markdown
# Prompt Interactive Programming - Database Updates - Modifications V 3.0


## üéØ Initial Context
- This V3 planning aims to adapt the database update flow to reflect the deep changes made to the resource structure (layouts, pages, components, variables) according to version 2 of the resource data update process.
- Main references:
    - Planning and registration of resource changes: `ai-workspace/prompts/architecture/update-resource-data-v2.md`
    - Database update script: `gestor/controladores/atualizacoes/atualizacoes-banco-de-dados.php`

### Resource Changes Diagnosis (V2)
1. **Numeric IDs removed**: Resource Data.json files no longer have numeric identifier fields (ex: id_layouts, id_paginas, etc). PK control is done exclusively by the database (auto increment).
2. **Layout reference in pages**: The `layout_id` field is now textual, coming directly from the `layout` field of the origin. There is no more `id_layouts` in pages.
3. **Uniqueness rules**:
     - layouts/components: id+language unique
     - pages: id+language+module unique; path unique per language
     - variables: id+language+module (+group allows multiples)
4. **Orphans**: Records that violate uniqueness or rules are segregated into their own files in the `gestor/db/orphans` folder.
5. **Seeders**: Will not be executed directly because the update routine inserts data if they do not exist. Seeders are used in the installation process. Here is the update process.
6. **Version/Checksum**: Increment only when html/css change; checksum consolidated as JSON string.

### Impacts and Necessary Adaptations in the Database Update Script
1. **Remove dependency on numeric IDs**: All insert/update flows must use only natural resource data. PKs are generated by the database.
2. **Update layout reference logic**: Ensure pages use textual `layout_id` and do not try to map to numeric fields.
3. **Review uniqueness rules**: Validate that synchronization respects new rules and segregates orphans correctly.
4. **Remove obsolete fields**: Eliminate any logic, field or reference to notifications, dates or identifiers that no longer exist in the resource structure. Dates for example are automatically generated within MySQL, both on creation and update. The same for `id_usuarios`, which defaults to 1 in MySQL.
5. **Orphans**: Implement/adjust logic to export problematic records to the orphans folder, according to resource standards. `gestor/db/orphans`
6. **Versioning**: Ensure versioning/checksum follows the new standard.

### Planning Checklist for Script Adaptation
- [x] Map all script points that depend on numeric IDs or old reference logic.
- [x] List obsolete fields and flows to be removed.
- [x] Plan adaptation of inserts/updates to use only natural data.
- [x] Validate and adapt uniqueness rules and orphan segregation. (implemented: export/log/ignore with --orphans-mode)
- [x] Document all decisions and alternatives considered.
- [x] Review and approve planning collaboratively before starting implementation.

### Observations
- Planning will be iterative and collaborative. New points can be added as analysis and discussion proceed.
- After validation of all items, implementation of adaptations in the database update script will begin.

## üìù Guidelines for the Agent

## üß≠ Source Code Structure
```
...Other Functions...

main():
    ... Other Logics ...
    
    ... Other Logics ...

main()
```

## ü§î Doubts and üìù Suggestions

## ‚úÖ Implementation Progress

### Change 1: Natural Keys Support (layouts, pages, components, variables)
- Refactored `synchronizeTable` function to operate in two modes: `pk` (legacy) and `natural` (new).
- Natural mode active when the table is in the resource list and the JSON does not contain the numeric PK.
- Natural key rules implemented:
    - layouts/components: language|id
    - pages: language|module|id
    - variables: language|module|group|id
- Preservation of `html/css/value` fields when `user_modified=1` maintained for both modes.
- Insertions filter fields starting with `id_` to let auto increment act.
- Updates use numeric PK if available or WHERE clause composed of natural fields.
- Differentiated logs (`*_NAT`) for operational clarity.

Change 2: Orphan Segregation
- Implemented orphan detection and export mode to `gestor/db/orphans/bd/` with timestamp.
- Supports `--orphans-mode=export|log|ignore` (default export).
- Exports JSON with metadata (table, total, timestamp).
- Logs: `ORPHANS_EXPORTED`, `ORPHANS_LOGGED`, `ORPHANS_IGNORED`.
Next step: Test in Docker environment (synchronization + execution) and validate integrity of orphan files.

## ‚òëÔ∏è Post-Implementation Process
- [x] Execute the generated script to see if it works correctly.
- [x] Generate detailed message, replace with the text below and execute the GIT script below:

./ai-workspace/git/scripts/commit.sh "Database synchronization script update:
- Refactoring for full support of natural keys in layouts, pages, components and variables.
- Removal of dependency on numeric IDs in inserts/updates.
- Implementation of fallback to avoid record duplication when language was null (fixes historical bug).
- Adaptation of WHERE clauses to dynamically use the correct language field.
- Export and segregation of orphans according to resource uniqueness rules.
- Idempotent synchronization: second execution does not insert duplicates.
- Complete tests in Docker environment, clean database and applied migrations."

---
**Date:** currentDate()
**Developer:** Otavio Serra
**Project:** Conn2Flow v1.10.18
````