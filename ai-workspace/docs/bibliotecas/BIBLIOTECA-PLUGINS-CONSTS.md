# Biblioteca: plugins-consts.php

> üîß Constantes e c√≥digos de status do sistema de plugins

## Vis√£o Geral

A biblioteca `plugins-consts.php` define constantes essenciais para o sistema de instala√ß√£o e gerenciamento de plugins do Conn2Flow. Estabelece c√≥digos de sa√≠da padronizados e status de execu√ß√£o que permitem rastreamento e debugging consistente durante opera√ß√µes com plugins.

**Localiza√ß√£o**: `gestor/bibliotecas/plugins-consts.php`  
**Vers√£o**: Fase 1  
**Total de Fun√ß√µes**: 1 (helper)  
**Total de Constantes**: 12

## Depend√™ncias

- Nenhuma depend√™ncia de outras bibliotecas
- Alinhado com documenta√ß√£o em `ai-workspace/prompts/plugins/modificar-plugins.md`

## Constantes Definidas

### C√≥digos de Sa√≠da (Exit Codes)

Constantes que indicam o resultado de opera√ß√µes com plugins:

#### PLG_EXIT_OK
```php
define('PLG_EXIT_OK', 0);
```
**Descri√ß√£o**: Opera√ß√£o conclu√≠da com sucesso  
**Uso**: Retornado quando plugin √© instalado/atualizado sem erros

#### PLG_EXIT_PARAMS_OR_FILE
```php
define('PLG_EXIT_PARAMS_OR_FILE', 10);
```
**Descri√ß√£o**: Erro de par√¢metros ou arquivo n√£o encontrado  
**Causas Comuns**:
- Par√¢metros obrigat√≥rios n√£o fornecidos
- Arquivo de plugin n√£o encontrado
- Caminho inv√°lido

#### PLG_EXIT_VALIDATE
```php
define('PLG_EXIT_VALIDATE', 11);
```
**Descri√ß√£o**: Falha na valida√ß√£o do plugin  
**Causas Comuns**:
- Estrutura de diret√≥rios inv√°lida
- Arquivos obrigat√≥rios faltando
- Metadados (metadata.json) inv√°lidos
- Vers√£o incompat√≠vel

#### PLG_EXIT_MOVE
```php
define('PLG_EXIT_MOVE', 12);
```
**Descri√ß√£o**: Falha ao mover arquivos do plugin  
**Causas Comuns**:
- Permiss√µes insuficientes no diret√≥rio de destino
- Espa√ßo em disco insuficiente
- Diret√≥rio de destino n√£o existe

#### PLG_EXIT_DOWNLOAD
```php
define('PLG_EXIT_DOWNLOAD', 20);
```
**Descri√ß√£o**: Falha no download do plugin  
**Causas Comuns**:
- URL inv√°lida ou inacess√≠vel
- Problema de conectividade
- Timeout na requisi√ß√£o
- Servidor remoto indispon√≠vel

#### PLG_EXIT_ZIP_INVALID
```php
define('PLG_EXIT_ZIP_INVALID', 21);
```
**Descri√ß√£o**: Arquivo ZIP inv√°lido ou corrompido  
**Causas Comuns**:
- Arquivo ZIP corrompido
- N√£o √© um arquivo ZIP v√°lido
- Falha ao extrair conte√∫do

#### PLG_EXIT_CHECKSUM
```php
define('PLG_EXIT_CHECKSUM', 22);
```
**Descri√ß√£o**: Falha na verifica√ß√£o de checksum/integridade  
**Causas Comuns**:
- Hash SHA256 n√£o corresponde
- Arquivo modificado ap√≥s cria√ß√£o
- Arquivo corrompido durante download

---

### Status de Execu√ß√£o

Constantes que indicam o estado atual de uma opera√ß√£o com plugin:

#### PLG_STATUS_IDLE
```php
define('PLG_STATUS_IDLE', 'idle');
```
**Descri√ß√£o**: Sistema em repouso, nenhuma opera√ß√£o em andamento  
**Transi√ß√µes**: `idle` ‚Üí `instalando` ou `atualizando`

#### PLG_STATUS_INSTALANDO
```php
define('PLG_STATUS_INSTALANDO', 'instalando');
```
**Descri√ß√£o**: Plugin sendo instalado  
**Transi√ß√µes**: `instalando` ‚Üí `ok` ou `erro`

#### PLG_STATUS_ATUALIZANDO
```php
define('PLG_STATUS_ATUALIZANDO', 'atualizando');
```
**Descri√ß√£o**: Plugin sendo atualizado  
**Transi√ß√µes**: `atualizando` ‚Üí `ok` ou `erro`

#### PLG_STATUS_ERRO
```php
define('PLG_STATUS_ERRO', 'erro');
```
**Descri√ß√£o**: Opera√ß√£o falhou  
**Transi√ß√µes**: `erro` ‚Üí `idle` (ap√≥s tratamento)

#### PLG_STATUS_OK
```php
define('PLG_STATUS_OK', 'ok');
```
**Descri√ß√£o**: Opera√ß√£o conclu√≠da com sucesso  
**Transi√ß√µes**: `ok` ‚Üí `idle`

---

## Fun√ß√£o Helper

### plg_exit_code_label()

Converte c√≥digo de sa√≠da num√©rico em label descritivo para debugging.

**Assinatura:**
```php
function plg_exit_code_label(int $code): string
```

**Par√¢metros:**
- `$code` (int) - **Obrigat√≥rio** - C√≥digo de sa√≠da num√©rico

**Retorno:**
- (string) - Label descritivo do c√≥digo ou 'UNKNOWN' se n√£o reconhecido

**C√≥digos Suportados:**

| C√≥digo | Label | Descri√ß√£o |
|--------|-------|-----------|
| 0 | `OK` | Sucesso |
| 10 | `PARAMS_OR_FILE` | Erro de par√¢metros/arquivo |
| 11 | `VALIDATE` | Falha na valida√ß√£o |
| 12 | `MOVE` | Falha ao mover arquivos |
| 20 | `DOWNLOAD` | Falha no download |
| 21 | `ZIP_INVALID` | ZIP inv√°lido |
| 22 | `CHECKSUM` | Falha no checksum |
| Outro | `UNKNOWN` | C√≥digo desconhecido |

**Exemplo de Uso:**
```php
$result_code = instalar_plugin($plugin_data);

if($result_code !== PLG_EXIT_OK) {
    $label = plg_exit_code_label($result_code);
    error_log("Falha na instala√ß√£o: " . $label . " (c√≥digo: " . $result_code . ")");
}

// Exemplo de output de log:
// "Falha na instala√ß√£o: CHECKSUM (c√≥digo: 22)"
```

---

## Casos de Uso

### 1. Instala√ß√£o de Plugin

```php
function instalar_plugin_wrapper($plugin_url, $plugin_name) {
    // Atualizar status
    atualizar_status_plugin($plugin_name, PLG_STATUS_INSTALANDO);
    
    // Tentar instala√ß√£o
    $result = instalar_plugin(Array(
        'url' => $plugin_url,
        'nome' => $plugin_name
    ));
    
    // Processar resultado
    switch($result) {
        case PLG_EXIT_OK:
            atualizar_status_plugin($plugin_name, PLG_STATUS_OK);
            log_plugin("Plugin $plugin_name instalado com sucesso");
            break;
            
        case PLG_EXIT_DOWNLOAD:
            atualizar_status_plugin($plugin_name, PLG_STATUS_ERRO);
            log_plugin("Falha no download do plugin $plugin_name", 'error');
            break;
            
        case PLG_EXIT_VALIDATE:
            atualizar_status_plugin($plugin_name, PLG_STATUS_ERRO);
            log_plugin("Plugin $plugin_name falhou na valida√ß√£o", 'error');
            break;
            
        case PLG_EXIT_CHECKSUM:
            atualizar_status_plugin($plugin_name, PLG_STATUS_ERRO);
            log_plugin("Checksum inv√°lido para plugin $plugin_name", 'error');
            break;
            
        default:
            atualizar_status_plugin($plugin_name, PLG_STATUS_ERRO);
            $label = plg_exit_code_label($result);
            log_plugin("Erro desconhecido: $label (c√≥digo: $result)", 'error');
    }
    
    return $result;
}
```

### 2. Sistema de Logging Detalhado

```php
function log_operacao_plugin($operacao, $codigo_saida, $detalhes = '') {
    global $_BANCO;
    
    $status_label = plg_exit_code_label($codigo_saida);
    $sucesso = ($codigo_saida === PLG_EXIT_OK) ? 1 : 0;
    
    banco_query(
        "INSERT INTO plugins_log 
         (operacao, codigo_saida, status_label, sucesso, detalhes, data_hora) 
         VALUES 
         ('" . banco_escape_field($operacao) . "',
          " . $codigo_saida . ",
          '" . banco_escape_field($status_label) . "',
          " . $sucesso . ",
          '" . banco_escape_field($detalhes) . "',
          NOW())"
    );
}

// Uso:
$result = instalar_plugin($data);
log_operacao_plugin('instalacao', $result, "Plugin: $plugin_name");
```

### 3. Interface de Progresso

```php
function obter_status_instalacao($plugin_id) {
    global $_BANCO;
    
    $status = banco_select_one(
        "SELECT status_execucao, ultimo_codigo_erro 
         FROM plugins_instalacao 
         WHERE plugin_id = '" . banco_escape_field($plugin_id) . "'"
    );
    
    $resposta = Array(
        'status' => $status['status_execucao'],
        'em_progresso' => in_array($status['status_execucao'], [
            PLG_STATUS_INSTALANDO,
            PLG_STATUS_ATUALIZANDO
        ]),
        'finalizado' => in_array($status['status_execucao'], [
            PLG_STATUS_OK,
            PLG_STATUS_ERRO,
            PLG_STATUS_IDLE
        ]),
        'sucesso' => ($status['status_execucao'] === PLG_STATUS_OK)
    );
    
    if($status['ultimo_codigo_erro']) {
        $resposta['erro_label'] = plg_exit_code_label($status['ultimo_codigo_erro']);
        $resposta['erro_codigo'] = $status['ultimo_codigo_erro'];
    }
    
    return $resposta;
}

// Uso em AJAX:
// GET /api/plugin/status/123
$status = obter_status_instalacao($_GET['plugin_id']);
echo json_encode($status);

// Resposta:
// {
//   "status": "instalando",
//   "em_progresso": true,
//   "finalizado": false,
//   "sucesso": false
// }
```

### 4. Valida√ß√£o e Tratamento de Erros

```php
function processar_resultado_plugin($codigo) {
    $mensagens = Array(
        PLG_EXIT_OK => Array(
            'tipo' => 'success',
            'titulo' => 'Sucesso',
            'mensagem' => 'Plugin instalado com sucesso!'
        ),
        PLG_EXIT_PARAMS_OR_FILE => Array(
            'tipo' => 'error',
            'titulo' => 'Erro de Par√¢metros',
            'mensagem' => 'Par√¢metros inv√°lidos ou arquivo n√£o encontrado.'
        ),
        PLG_EXIT_VALIDATE => Array(
            'tipo' => 'error',
            'titulo' => 'Valida√ß√£o Falhou',
            'mensagem' => 'O plugin n√£o passou na valida√ß√£o. Verifique a estrutura.'
        ),
        PLG_EXIT_DOWNLOAD => Array(
            'tipo' => 'error',
            'titulo' => 'Erro de Download',
            'mensagem' => 'N√£o foi poss√≠vel baixar o plugin. Verifique a conex√£o.'
        ),
        PLG_EXIT_ZIP_INVALID => Array(
            'tipo' => 'error',
            'titulo' => 'ZIP Inv√°lido',
            'mensagem' => 'O arquivo ZIP est√° corrompido ou inv√°lido.'
        ),
        PLG_EXIT_CHECKSUM => Array(
            'tipo' => 'error',
            'titulo' => 'Verifica√ß√£o de Integridade',
            'mensagem' => 'O checksum do arquivo n√£o corresponde. Arquivo pode estar corrompido.'
        )
    );
    
    return $mensagens[$codigo] ?? Array(
        'tipo' => 'error',
        'titulo' => 'Erro Desconhecido',
        'mensagem' => 'Erro: ' . plg_exit_code_label($codigo)
    );
}

// Uso:
$resultado_instalacao = instalar_plugin($data);
$feedback = processar_resultado_plugin($resultado_instalacao);

// Exibir ao usu√°rio:
echo '<div class="alert alert-' . $feedback['tipo'] . '">';
echo '<strong>' . $feedback['titulo'] . '</strong>: ';
echo $feedback['mensagem'];
echo '</div>';
```

### 5. M√°quina de Estados

```php
class PluginStateMachine {
    private $plugin_id;
    private $status_atual;
    
    public function __construct($plugin_id) {
        $this->plugin_id = $plugin_id;
        $this->status_atual = $this->obter_status();
    }
    
    public function pode_iniciar_instalacao() {
        return $this->status_atual === PLG_STATUS_IDLE;
    }
    
    public function pode_atualizar() {
        return in_array($this->status_atual, [
            PLG_STATUS_IDLE,
            PLG_STATUS_OK
        ]);
    }
    
    public function transicao_para($novo_status) {
        $transicoes_validas = Array(
            PLG_STATUS_IDLE => [PLG_STATUS_INSTALANDO, PLG_STATUS_ATUALIZANDO],
            PLG_STATUS_INSTALANDO => [PLG_STATUS_OK, PLG_STATUS_ERRO],
            PLG_STATUS_ATUALIZANDO => [PLG_STATUS_OK, PLG_STATUS_ERRO],
            PLG_STATUS_OK => [PLG_STATUS_ATUALIZANDO, PLG_STATUS_IDLE],
            PLG_STATUS_ERRO => [PLG_STATUS_IDLE, PLG_STATUS_INSTALANDO]
        );
        
        if(in_array($novo_status, $transicoes_validas[$this->status_atual] ?? [])) {
            $this->atualizar_status($novo_status);
            $this->status_atual = $novo_status;
            return true;
        }
        
        return false;
    }
    
    private function obter_status() {
        // Consultar banco de dados
    }
    
    private function atualizar_status($status) {
        // Atualizar banco de dados
    }
}

// Uso:
$state = new PluginStateMachine($plugin_id);

if($state->pode_iniciar_instalacao()) {
    $state->transicao_para(PLG_STATUS_INSTALANDO);
    // ... realizar instala√ß√£o ...
    $state->transicao_para(PLG_STATUS_OK);
}
```

## Diagrama de Fluxo de Estados

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    PLG_STATUS_IDLE                       ‚îÇ
‚îÇ                  (Estado Inicial)                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ                            ‚îÇ
     ‚ñº                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ INSTALANDO  ‚îÇ          ‚îÇ ATUALIZANDO  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                        ‚îÇ
       ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ    ‚îÇ
       ‚ñº    ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  OK    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
                      ‚îÇ
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ ERRO   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚ñº
    (volta para IDLE ap√≥s tratamento)
```

## Mapeamento de C√≥digos de Sa√≠da

| Categoria | C√≥digos | Recuper√°vel? | A√ß√£o Sugerida |
|-----------|---------|--------------|---------------|
| **Sucesso** | 0 | N/A | Nenhuma |
| **Par√¢metros** | 10-12 | Sim | Corrigir entrada/permiss√µes |
| **Download/ZIP** | 20-22 | Parcial | Tentar novamente ou verificar arquivo |

## Refer√™ncias de Documenta√ß√£o

Esta biblioteca est√° alinhada com:
- `ai-workspace/prompts/plugins/modificar-plugins.md` - Documenta√ß√£o principal do sistema de plugins
- `gestor/bibliotecas/plugins-installer.php` - Implementa√ß√£o do instalador
- `gestor/bibliotecas/plugins.php` - Utilit√°rios de plugins

## Extens√µes Futuras

Poss√≠veis adi√ß√µes a esta biblioteca:

```php
// C√≥digos adicionais para opera√ß√µes espec√≠ficas
define('PLG_EXIT_DEPENDENCY', 30);      // Depend√™ncia n√£o satisfeita
define('PLG_EXIT_INCOMPATIBLE', 31);    // Vers√£o incompat√≠vel
define('PLG_EXIT_ALREADY_INSTALLED', 32); // J√° instalado

// Status adicionais
define('PLG_STATUS_DESINSTALANDO', 'desinstalando');
define('PLG_STATUS_PAUSADO', 'pausado');
define('PLG_STATUS_AGUARDANDO', 'aguardando_dependencia');
```

## Veja Tamb√©m

- [BIBLIOTECA-PLUGINS-INSTALLER.md](./BIBLIOTECA-PLUGINS-INSTALLER.md) - Sistema de instala√ß√£o
- [BIBLIOTECA-PLUGINS.md](./BIBLIOTECA-PLUGINS.md) - Utilit√°rios de plugins
- [Plugin Architecture](../../CONN2FLOW-PLUGIN-ARCHITECTURE.md) - Arquitetura geral

---

**√öltima Atualiza√ß√£o**: Outubro 2025  
**Documentado por**: Equipe Conn2Flow
