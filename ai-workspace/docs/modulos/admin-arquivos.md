# M√≥dulo: admin-arquivos

## üìã Informa√ß√µes Gerais

| Campo | Valor |
|-------|-------|
| **ID do M√≥dulo** | `admin-arquivos` |
| **Nome** | Administra√ß√£o de Arquivos |
| **Vers√£o** | `1.1.0` |
| **Categoria** | M√≥dulo Administrativo |
| **Complexidade** | üî¥ Alta |
| **Status** | ‚úÖ Ativo |
| **Depend√™ncias** | `interface`, `html` |

## üéØ Prop√≥sito

O m√≥dulo **admin-arquivos** √© o **sistema central de gerenciamento de arquivos e m√≠dias** do Conn2Flow. Respons√°vel por toda a funcionalidade de upload, organiza√ß√£o, categoriza√ß√£o e gerenciamento de arquivos digitais (imagens, v√≠deos, documentos, etc.).

## üèóÔ∏è Funcionalidades Principais

### üì§ **Sistema de Upload**
- **Upload m√∫ltiplo**: Suporte a v√°rios arquivos simultaneamente
- **Valida√ß√£o de tamanho**: Limite m√°ximo de 10MB por arquivo
- **Tipos suportados**: Imagens, v√≠deos, √°udios, documentos
- **Gera√ß√£o autom√°tica de thumbnails**: Para imagens e v√≠deos
- **Organiza√ß√£o por data**: Estrutura autom√°tica `YYYY/MM/`
- **Nomes √∫nicos**: Sistema de identificadores √∫nicos para evitar conflitos

### üóÇÔ∏è **Organiza√ß√£o e Categoriza√ß√£o**
- **Categorias m√∫ltiplas**: Um arquivo pode pertencer a v√°rias categorias
- **Filtros avan√ßados**: Por data, categoria, tipo, nome
- **Ordena√ß√£o flex√≠vel**: Alfab√©tica, por data (crescente/decrescente)
- **Pagina√ß√£o**: 100 arquivos por p√°gina
- **Busca r√°pida**: Sistema de pesquisa em tempo real

### üñºÔ∏è **Visualiza√ß√£o e Gest√£o**
- **Preview inteligente**: Miniaturas autom√°ticas para diferentes tipos
- **Informa√ß√µes detalhadas**: Nome, data, tipo, tamanho
- **A√ß√µes r√°pidas**: Copiar URL, selecionar, editar, excluir
- **Modal responsivo**: Interface adapt√°vel para diferentes dispositivos
- **Suporte iframe**: Integra√ß√£o em popups e modais

### üîó **Integra√ß√£o com Sistema**
- **CKEditor**: Integra√ß√£o nativa com editor de texto
- **Seletor de arquivos**: Modal para sele√ß√£o em outros m√≥dulos
- **API REST**: Endpoints para opera√ß√µes program√°ticas
- **Links permanentes**: URLs est√°veis para arquivos

## üóÑÔ∏è Estrutura de Banco de Dados

### Tabela Principal: `arquivos`
```sql
CREATE TABLE arquivos (
    id_arquivos INT AUTO_INCREMENT PRIMARY KEY,
    id_usuarios INT NOT NULL,                 -- Usu√°rio que fez upload
    nome VARCHAR(255) NOT NULL,               -- Nome original do arquivo
    id VARCHAR(255) UNIQUE NOT NULL,          -- Identificador √∫nico
    tipo VARCHAR(100),                        -- MIME type
    caminho VARCHAR(500),                     -- Caminho do arquivo
    caminho_mini VARCHAR(500),                -- Caminho da miniatura
    status CHAR(1) DEFAULT 'A',               -- Status (A=Ativo, D=Deletado)
    versao INT DEFAULT 1,                     -- Controle de vers√£o
    data_criacao DATETIME DEFAULT NOW(),      -- Data de upload
    data_modificacao DATETIME DEFAULT NOW(),   -- √öltima modifica√ß√£o
    INDEX idx_status (status),
    INDEX idx_usuario (id_usuarios),
    INDEX idx_tipo (tipo),
    FOREIGN KEY (id_usuarios) REFERENCES usuarios(id_usuarios)
);
```

### Tabela de Relacionamento: `arquivos_categorias`
```sql
CREATE TABLE arquivos_categorias (
    id_arquivos INT NOT NULL,
    id_categorias INT NOT NULL,
    PRIMARY KEY (id_arquivos, id_categorias),
    FOREIGN KEY (id_arquivos) REFERENCES arquivos(id_arquivos),
    FOREIGN KEY (id_categorias) REFERENCES categorias(id_categorias)
);
```

## üìÅ Estrutura de Arquivos

### Organiza√ß√£o F√≠sica
```
contents/files/
‚îú‚îÄ‚îÄ YYYY/                    # Ano
‚îÇ   ‚îî‚îÄ‚îÄ MM/                  # M√™s
‚îÇ       ‚îú‚îÄ‚îÄ arquivo.ext      # Arquivo original
‚îÇ       ‚îî‚îÄ‚îÄ mini/            # Miniaturas
‚îÇ           ‚îî‚îÄ‚îÄ arquivo.ext  # Thumbnail
```

### C√≥digos Principais

#### üîß **Fun√ß√µes PHP Core**

##### `admin_arquivos_lista($params)`
Fun√ß√£o principal para listagem de arquivos com suporte a filtros, pagina√ß√£o e categoriza√ß√£o.

**Par√¢metros:**
- `pagina` (string): Template onde ser√° renderizada a lista

**Funcionalidades:**
- Aplica√ß√£o de filtros (data, categoria, ordena√ß√£o)
- Pagina√ß√£o com 100 itens por p√°gina
- Agrupamento por categorias
- Suporte AJAX para carregamento din√¢mico
- Gera√ß√£o de URLs e miniaturas

##### `admin_arquivos_ajax_upload_file()`
Processamento AJAX de upload de arquivos.

**Funcionalidades:**
- Valida√ß√£o de tamanho (m√°x. 10MB)
- Gera√ß√£o de identificador √∫nico
- Cria√ß√£o de estrutura de diret√≥rios
- Processamento de miniaturas
- Inser√ß√£o no banco de dados
- Retorno JSON com status

##### `admin_arquivos_criar_dir_herdando_permissao($dir)`
Cria√ß√£o de diret√≥rios com heran√ßa de permiss√µes do diret√≥rio pai.

#### üñ•Ô∏è **JavaScript Core**

##### Sistema de Upload jQuery File Upload
```javascript
$('#fileupload').fileupload({
    url: 'admin-arquivos/?ajax=upload_file',
    dataType: 'json',
    maxFileSize: 10000000, // 10MB
    acceptFileTypes: /(\.|\/)(gif|jpe?g|png|mp4|pdf|doc|docx)$/i
});
```

##### Sistema de Filtros
```javascript
// Filtros por data, categoria e ordena√ß√£o
var filtros = {
    dataDe: $('#rangestart').calendar('get date'),
    dataAte: $('#rangeend').calendar('get date'),
    categorias: $('#categories').dropdown('get value'),
    order: $('#order').dropdown('get value')
};
```

##### Pagina√ß√£o AJAX
```javascript
function carregarMaisArquivos() {
    $.post('admin-arquivos/?ajax=lista_mais_resultados', {
        pagina: listaPaginaAtual + 1,
        filtros: JSON.stringify(filtros)
    }, function(data) {
        $('#files-list-cont').append(data.pagina);
        listaPaginaAtual++;
    });
}
```

## üé® Interface de Usu√°rio

### üì± **Layout Responsivo**
- **Desktop**: Grid de 4 colunas com thumbnails grandes
- **Tablet**: Grid de 3 colunas com thumbnails m√©dios  
- **Mobile**: Lista vertical com thumbnails pequenos

### üîΩ **√Årea de Upload (Drag & Drop)**
```html
<div class="upload-zone">
    <div class="dz-message">
        <i class="cloud upload icon"></i>
        <p>Arraste arquivos aqui ou clique para selecionar</p>
    </div>
</div>
```

### üóÉÔ∏è **Lista de Arquivos**
```html
<div class="files-grid">
    <div class="file-card" data-file-id="123">
        <div class="thumbnail">
            <img src="files/2024/08/mini/imagem.jpg" alt="Imagem">
        </div>
        <div class="file-info">
            <h4>imagem.jpg</h4>
            <span class="file-date">31/08/2024 15:30</span>
            <span class="file-type">image/jpeg</span>
        </div>
        <div class="file-actions">
            <button class="btn-copy" data-url="files/2024/08/imagem.jpg">
                <i class="copy icon"></i> Copiar URL
            </button>
            <button class="btn-select">
                <i class="check icon"></i> Selecionar
            </button>
        </div>
    </div>
</div>
```

### üéõÔ∏è **Filtros Avan√ßados**
```html
<div class="filters-panel">
    <div class="ui form">
        <div class="fields">
            <div class="field">
                <label>Per√≠odo</label>
                <div class="ui calendar" id="rangestart">
                    <input type="text" placeholder="Data inicial">
                </div>
            </div>
            <div class="field">
                <div class="ui calendar" id="rangeend">
                    <input type="text" placeholder="Data final">
                </div>
            </div>
            <div class="field">
                <label>Categorias</label>
                <select id="categories" class="ui multiple dropdown">
                    <option value="">Todas as categorias</option>
                </select>
            </div>
            <div class="field">
                <label>Ordena√ß√£o</label>
                <select id="order" class="ui dropdown">
                    <option value="alphabetical-asc">A-Z</option>
                    <option value="alphabetical-desc">Z-A</option>
                    <option value="order-date-asc">Mais antigos</option>
                    <option value="order-date-desc">Mais recentes</option>
                </select>
            </div>
        </div>
        <div class="buttons">
            <button class="ui button filterButton">Filtrar</button>
            <button class="ui button clearButton">Limpar</button>
        </div>
    </div>
</div>
```

## üîå Integra√ß√£o com Outros M√≥dulos

### üìù **CKEditor (Editor de Texto)**
O m√≥dulo se integra nativamente com o CKEditor para inser√ß√£o de imagens:

```javascript
CKEDITOR.config.filebrowserBrowseUrl = 'admin-arquivos/?paginaIframe=sim';
CKEDITOR.config.filebrowserImageBrowseUrl = 'admin-arquivos/?paginaIframe=sim&tipo=imagem';
```

### üè∑Ô∏è **M√≥dulo Categorias**
Integra√ß√£o bidirecional para categoriza√ß√£o de arquivos:

```php
// Buscar categorias dispon√≠veis
$categorias = banco_select_name(
    "nome, id_categorias",
    "categorias",
    "WHERE id_modulos='11' OR id_modulos IS NULL"
);

// Associar arquivo a categorias
foreach($_POST['categorias'] as $id_categoria) {
    banco_insert_name([
        ['id_arquivos', $id_arquivo],
        ['id_categorias', $id_categoria]
    ], 'arquivos_categorias');
}
```

### üë• **Sistema de Usu√°rios**
Controle de propriedade e permiss√µes:

```php
// Verificar permiss√£o de upload
if(!gestor_usuario_permissao('admin-arquivos', 'upload')) {
    return gestor_erro('Sem permiss√£o para upload');
}

// Registrar propriet√°rio do arquivo
$id_usuario = gestor_usuario()['id_usuarios'];
```

## ‚öôÔ∏è Configura√ß√µes e Par√¢metros

### üìê **Limites e Valida√ß√µes**
```php
// Configura√ß√µes de upload
define('MAX_FILE_SIZE', 10000000);           // 10MB
define('ALLOWED_TYPES', [
    'image/jpeg', 'image/png', 'image/gif',   // Imagens
    'video/mp4', 'video/webm',                // V√≠deos
    'audio/mp3', 'audio/wav',                 // √Åudios
    'application/pdf',                        // Documentos
    'application/msword',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
]);
```

### üóÇÔ∏è **Estrutura de Diret√≥rios**
```php
// Configura√ß√£o autom√°tica de pastas
$basedir = 'files';
$thumbnail = 'mini';
$caminho = $basedir . '/' . date('Y') . '/' . date('m') . '/';
$caminho_mini = $caminho . $thumbnail . '/';
```

### üìä **Pagina√ß√£o**
```php
// Configura√ß√£o de listagem
$max_dados_por_pagina = 100;
$total_paginas = ceil($total_arquivos / $max_dados_por_pagina);
```

## üõ°Ô∏è Seguran√ßa

### üîí **Valida√ß√µes de Upload**
- **Verifica√ß√£o de tipo MIME**: Apenas tipos permitidos
- **Valida√ß√£o de extens√£o**: Dupla verifica√ß√£o
- **Limite de tamanho**: Prote√ß√£o contra uploads grandes
- **Sanitiza√ß√£o de nomes**: Remo√ß√£o de caracteres perigosos
- **Verifica√ß√£o de propriedade**: Usu√°rio autenticado

### üóÇÔ∏è **Prote√ß√£o de Diret√≥rios**
```php
// Cria√ß√£o segura de diret√≥rios
function admin_arquivos_criar_dir_herdando_permissao($dir) {
    if (!is_dir($dir)) {
        $pai = dirname($dir);
        $permissao_pai = is_dir($pai) ? fileperms($pai) & 0777 : 0755;
        mkdir($dir, $permissao_pai, true);
    }
}
```

### üö´ **Preven√ß√£o de Ataques**
- **SQL Injection**: Uso de `banco_escape_field()`
- **XSS**: Sanitiza√ß√£o de dados de entrada
- **Path Traversal**: Valida√ß√£o de caminhos
- **Upload de Scripts**: Verifica√ß√£o rigorosa de tipos

## üìà Performance e Otimiza√ß√£o

### ‚ö° **Estrat√©gias de Performance**
- **Lazy Loading**: Carregamento sob demanda de miniaturas
- **Pagina√ß√£o AJAX**: Evita recarregamento completo da p√°gina
- **Cache de Thumbnails**: Gera√ß√£o √∫nica e reutiliza√ß√£o
- **√çndices de Banco**: Otimiza√ß√£o de consultas
- **Compress√£o de Imagens**: Redu√ß√£o autom√°tica de qualidade

### üóÉÔ∏è **Cache e Armazenamento**
```php
// Sistema de cache de miniaturas
if (!file_exists($caminho_arquivo_mini)) {
    $imagem_redimensionada = imagescale($imagem_original, 300, 300);
    imagejpeg($imagem_redimensionada, $caminho_arquivo_mini, 80);
}
```

## üîß APIs e Endpoints

### üì° **Endpoints AJAX**
| Endpoint | M√©todo | Fun√ß√£o |
|----------|--------|--------|
| `?ajax=upload_file` | POST | Upload de arquivo √∫nico |
| `?ajax=lista_mais_resultados` | POST | Pagina√ß√£o de arquivos |
| `?ajax=deletar_arquivo` | POST | Exclus√£o de arquivo |
| `?ajax=atualizar_categorias` | POST | Atualiza√ß√£o de categorias |

### üì• **Exemplo de Uso da API**
```javascript
// Upload via AJAX
var formData = new FormData();
formData.append('files[]', file);

$.ajax({
    url: 'admin-arquivos/?ajax=upload_file',
    type: 'POST',
    data: formData,
    processData: false,
    contentType: false,
    success: function(response) {
        if(response.status === 'Ok') {
            console.log('Upload realizado:', response.arquivo);
        }
    }
});
```

## üß™ Testes e Valida√ß√£o

### ‚úÖ **Casos de Teste**
- **Upload b√°sico**: Imagem JPG de 2MB
- **Upload m√∫ltiplo**: 5 arquivos de tipos diferentes
- **Valida√ß√£o de tamanho**: Arquivo de 15MB (deve falhar)
- **Filtros**: Busca por categoria espec√≠fica
- **Pagina√ß√£o**: Navega√ß√£o entre p√°ginas
- **Exclus√£o**: Remo√ß√£o de arquivo e cleanup

### üêõ **Problemas Conhecidos**
- **Timeout em uploads grandes**: Configurar `max_execution_time`
- **Permiss√µes de diret√≥rio**: Verificar propriedade www-data
- **Cache de thumbnails**: Limpeza manual ocasionalmente necess√°ria

## üìä M√©tricas e Monitoramento

### üìà **KPIs do M√≥dulo**
- **Arquivos totais**: Quantidade de arquivos no sistema
- **Uploads por dia**: Taxa de crescimento do reposit√≥rio
- **Tipos mais usados**: Estat√≠sticas de formato
- **Erros de upload**: Taxa de falhas
- **Uso de storage**: Espa√ßo em disco utilizado

### üìã **Logs Importantes**
```php
// Log de uploads
error_log("Upload realizado: {$nome} por usu√°rio {$id_usuario}");

// Log de erros
error_log("Erro no upload: {$erro} - arquivo: {$nome}");
```

## üöÄ Roadmap e Melhorias

### ‚úÖ **Implementado (v1.1.0)**
- Sistema b√°sico de upload
- Categoriza√ß√£o m√∫ltipla
- Filtros avan√ßados
- Interface responsiva
- Integra√ß√£o CKEditor

### üöß **Em Desenvolvimento (v1.2.0)**
- Editor de imagens integrado
- Suporte a v√≠deos HTML5
- Sincroniza√ß√£o com cloud storage
- API REST completa
- Compress√£o autom√°tica

### üîÆ **Planejado (v2.0.0)**
- Reconhecimento autom√°tico de conte√∫do (AI)
- Versionamento de arquivos
- Colabora√ß√£o em tempo real
- CDN integrado
- Backup autom√°tico

## üîó Depend√™ncias

### üìö **Bibliotecas JavaScript**
- **jQuery File Upload 10.31.0**: Sistema de upload
- **Semantic UI**: Interface de usu√°rio
- **Calendar JS**: Seletores de data
- **Modal Manager**: Sistema de modais

### üîß **Bibliotecas PHP**
- **GD Extension**: Processamento de imagens
- **cURL**: Comunica√ß√£o HTTP
- **ZIP Extension**: Compress√£o de arquivos
- **OpenSSL**: Seguran√ßa

### üóÑÔ∏è **Banco de Dados**
- **MySQL 5.7+**: Banco principal
- **Indices otimizados**: Performance de consultas
- **Foreign Keys**: Integridade referencial

## üìñ Conclus√£o

O m√≥dulo **admin-arquivos** √© uma pe√ßa fundamental do Conn2Flow, oferecendo um sistema robusto e completo para gerenciamento de arquivos digitais. Com interface moderna, funcionalidades avan√ßadas e integra√ß√£o profunda com o sistema, representa um dos m√≥dulos mais sofisticados da plataforma.

**Caracter√≠sticas principais:**
- ‚úÖ **Interface intuitiva** com drag & drop
- ‚úÖ **Performance otimizada** com lazy loading e cache
- ‚úÖ **Seguran√ßa robusta** com valida√ß√µes m√∫ltiplas
- ‚úÖ **Integra√ß√£o nativa** com editores e outros m√≥dulos
- ‚úÖ **Escalabilidade** preparada para grandes volumes

**Status**: ‚úÖ **Produ√ß√£o - Maduro e Est√°vel**  
**Mantenedores**: Equipe Core Conn2Flow  
**√öltima atualiza√ß√£o**: 31 de agosto, 2025
