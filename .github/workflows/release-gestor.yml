name: Release Gestor

on:
  push:
    tags:
      - 'gestor-v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: zip, curl, mbstring, openssl
        
    - name: Install Composer dependencies
      run: |
        cd gestor
        composer install --no-dev --optimize-autoloader --no-interaction
        
    - name: Generate Resources Updates
      run: |
        cd gestor/controladores/agents/arquitetura
        php atualizacao-dados-recursos.php
        echo "Resource updates generated successfully"

    - name: Commit Resources Updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add gestor/db/data/*.json
        git add gestor/db/orphans/*.json
        git add gestor/resources/*
        git add gestor/modulos/*/*.json
        git diff --cached --quiet || git commit -m "Auto-update resources for release ${{ github.ref_name }}"
        
    - name: Remove resource files
      run: |
        # Remove all resource files and directory to make installation lighter
        rm -rf gestor/resources/ && rmdir gestor/resources/ 2>/dev/null || true
        
        # Remove module resource files recursively
        find gestor/modulos -type d -name "resources" -exec rm -rf {} + || true
        
        echo "All resource files removed from release"
        
    - name: Create gestor.zip + checksum
      run: |
        # Remove arquivos desnecess√°rios se existirem
        rm -rf gestor/.git* || true
        rm -rf gestor/vendor/bin/.phpunit* || true
        rm -rf gestor/vendor/composer/tmp-* || true

        # Remover somente .env sens√≠veis da raiz (preservar templates em autenticacoes.exemplo)
        find gestor -maxdepth 1 -type f -name '.env*' -exec rm -f {} + 2>/dev/null || true
        # Remover .env internos reais de autenticacoes, exceto os de templates
        if [ -d gestor/autenticacoes ]; then
          find gestor/autenticacoes -type f -name '.env*' -not -path '*/autenticacoes.exemplo/*' -exec rm -f {} + 2>/dev/null || true
        fi

        # Criar o arquivo ZIP (resource files already removed)
        cd gestor
        zip -r ../gestor.zip . \
          -x "*.git*" \
          -x "vendor/bin/.phpunit*" \
          -x "vendor/composer/tmp-*" \
          -x "node_modules/*" \
          -x "*.DS_Store*" \
          -x "*.log*" \
          -x "tests/*" \
          -x "phpunit.xml*" \
          -x "resources/*" \
          -x "modulos/*/resources/*"
        cd ..
        sha256sum gestor.zip | awk '{print $1}' > gestor.zip.sha256

    - name: Get tag name
      id: tag
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.TAG_NAME }}
        name: "Gestor ${{ steps.tag.outputs.TAG_NAME }}"
        body: |
          ## üöÄ Conn2Flow Gestor Release v2.5.0 (Biblioteca Editor HTML Centralizada e Sistema de Templates Visual)

          Esta vers√£o traz a **implementa√ß√£o completa da biblioteca editor HTML centralizada** com sistema de templates visual usando cards Fomantic UI, al√©m de manter todas as funcionalidades revolucion√°rias do sistema de IA integrado, deploy OAuth e arquitetura multil√≠ngue.

          ### üéØ Novidades Principais desta Vers√£o:
          - ‚úÖ **Biblioteca Editor HTML Centralizada**: Nova biblioteca `html-editor.php` com funcionalidade de edi√ß√£o reutiliz√°vel entre m√≥dulos
          - ‚úÖ **Sistema de Sele√ß√£o de Templates Visual**: Interface moderna com cards Fomantic UI para sele√ß√£o intuitiva de templates de p√°gina
          - ‚úÖ **Editor HTML Modular Unificado**: Sistema de edi√ß√£o consistente para p√°ginas, templates e componentes
          - ‚úÖ **Sistema de Templates Multil√≠ngue**: Suporte avan√ßado a templates com prioriza√ß√£o de idioma e filtragem por alvo
          - ‚úÖ **Gerenciamento Avan√ßado de Templates**: Templates enriquecidos com miniaturas, metadados completos e integra√ß√£o CodeMirror profissional
          - ‚úÖ **Componentes Reutiliz√°veis**: Arquitetura de componentes compartilhados entre m√≥dulos admin-paginas e admin-templates
          - ‚úÖ **Integra√ß√£o IA Aprimorada**: Sistema de prompts inteligente com gerenciamento de sess√£o e inser√ß√£o posicional precisa
          - ‚úÖ **Arquitetura Baseada em Componentes**: Design modular para melhor manuten√ß√£o, reutiliza√ß√£o e escalabilidade
          - ‚úÖ **Sistema Completo de Deploy de Projetos via API OAuth**: Deploy automatizado completo com autentica√ß√£o OAuth 2.0 (mantido da v2.4.0)
          - ‚úÖ **Servidor OAuth 2.0 Completo**: Implementa√ß√£o completa com valida√ß√£o JWT e renova√ß√£o autom√°tica de tokens (mantido da v2.4.0)
          - ‚úÖ **Sistema de IA Completo Integrado**: Gera√ß√£o assistida de conte√∫do no admin-paginas via API Gemini (mantido da v2.4.0)
          - ‚úÖ **Sistema Multil√≠ngue Completo**: Suporte total pt-br/en com interface administrativa (mantido da v2.4.0)
          - ‚úÖ **Sistema de Plugins V2**: Arquitetura completamente refatorada com detec√ß√£o din√¢mica (mantido da v2.4.0)

          ### üîß Melhorias T√©cnicas:
          - ‚úÖ **Nova Biblioteca html-editor.php**: Fun√ß√µes completas para renderiza√ß√£o de componentes de edi√ß√£o e gerenciamento de templates
          - ‚úÖ **Sistema de Templates com Cards Fomantic UI**: Interface visual moderna para sele√ß√£o de templates com pagina√ß√£o AJAX
          - ‚úÖ **Integra√ß√£o CodeMirror Unificada**: Configura√ß√£o consistente de editor em todos os m√≥dulos admin
          - ‚úÖ **Sistema de Templates Multil√≠ngue**: Filtragem inteligente por idioma e alvo com metadados completos
          - ‚úÖ **Componentes Reutiliz√°veis**: Arquitetura de componentes compartilhados entre admin-paginas e admin-templates
          - ‚úÖ **Gerenciamento de Sess√£o IA Aprimorado**: Sistema inteligente para inser√ß√£o posicional de conte√∫do gerado
          - ‚úÖ **Scripts Core de Deploy**: `deploy-projeto.sh`, `renovar-token.sh`, `teste-integracao.sh` (mantido da v2.4.0)
          - ‚úÖ **API Endpoint Seguro**: `POST /_api/project/update` com autentica√ß√£o OAuth obrigat√≥ria (mantido da v2.4.0)
          - ‚úÖ **Nova Biblioteca ia.php**: Fun√ß√µes completas para renderiza√ß√£o de prompts e comunica√ß√£o com API Gemini (mantido da v2.4.0)
          - ‚úÖ **Novas Tabelas de Banco**: servidores_ia, modos_ia, prompts_ia para gerenciamento do sistema IA (mantido da v2.4.0)
          - ‚úÖ **Arquitetura de Plugins Refatorada**: Sistema V2 com detec√ß√£o autom√°tica (mantido da v2.4.0)
          - ‚úÖ **Configura√ß√£o Multil√≠ngue**: Interface intuitiva para mudan√ßa din√¢mica de idioma (pt-br/en) (mantido da v2.4.0)

          ### üì¶ Conte√∫do:
          - Sistema gestor completo com biblioteca editor HTML centralizada e sistema de templates visual
          - Nova biblioteca `html-editor.php` com componentes reutiliz√°veis
          - Sistema de sele√ß√£o de templates com interface de cards Fomantic UI
          - Scripts de deploy automatizado: deploy-projeto.sh, renovar-token.sh, teste-integracao.sh (mantido da v2.4.0)
          - Biblioteca ia.php funcional para opera√ß√µes de IA e OAuth (mantido da v2.4.0)
          - Sistema de plugins V2 com templates automatizados (mantido da v2.4.0)
          - API endpoint seguro para deploy de projetos (mantido da v2.4.0)
          - Migrations para tabelas IA, OAuth e templates
          - Sistema de atualiza√ß√£o autom√°tica consolidado
          - Recursos organizados por idioma (pt-br base)
          - Seletor de idioma padr√£o no m√≥dulo admin-environment
          - Instalador multil√≠ngue com sele√ß√£o de idioma
          - P√°gina de sucesso bil√≠ngue (pt-br/en)
          - Depend√™ncias do Composer otimizadas
          - Documenta√ß√£o t√©cnica completa incluindo sistema de templates

          ### üé® Sistema de Templates Visual:
          - **Biblioteca Editor HTML Centralizada**: Componentes reutiliz√°veis em `html-editor.php`
          - **Interface de Cards Fomantic UI**: Sele√ß√£o visual intuitiva de templates com miniaturas
          - **Sistema Multil√≠ngue**: Prioriza√ß√£o de idioma e filtragem por alvo
          - **Integra√ß√£o CodeMirror**: Editor profissional unificado em todos os m√≥dulos
          - **Gerenciamento de Metadados**: Templates com informa√ß√µes completas e categoriza√ß√£o
          - **Arquitetura Modular**: Componentes compartilhados entre admin-paginas e admin-templates

          ### üöÄ Sistema de Deploy de Projetos:
          - **API OAuth 2.0**: Autentica√ß√£o obrigat√≥ria com renova√ß√£o autom√°tica de tokens
          - **Deploy One-Click**: Atualiza√ß√£o autom√°tica ‚Üí compress√£o ‚Üí upload ‚Üí processamento
          - **Valida√ß√£o Robusta**: ZIP seguro com detec√ß√£o autom√°tica de estrutura
          - **Execu√ß√£o Inline**: Banco atualizado sem shell_exec para produ√ß√£o
          - **Tratamento de Erros**: Rollback autom√°tico e retry inteligente
          - **Performance Otimizada**: Redu√ß√£o de 28KB‚Üí25KB no ZIP (exclus√£o resources)

          ### ü§ñ Sistema de IA:
          - **Integra√ß√£o Gemini API**: Comunica√ß√£o direta com IA do Google para gera√ß√£o de conte√∫do
          - **Sistema Dual de Prompts**: Combina√ß√£o inteligente de modos t√©cnicos e necessidades do usu√°rio
          - **Interface Avan√ßada**: CodeMirror com inser√ß√£o posicional de conte√∫do gerado
          - **Gerenciamento de Sess√£o**: Sistema inteligente para manipula√ß√£o de conte√∫do IA
          - **Suporte Multi-Modelo**: Configura√ß√£o flex√≠vel de servidores e modelos de IA
          - **Valida√ß√£o Robusta**: Tratamento completo de erros e valida√ß√£o de API

          ### üåê Sistema Multil√≠ngue:
          - **Interface Administrativa**: Seletor de idioma no painel admin-environment
          - **Persist√™ncia Autom√°tica**: Salvamento em LANGUAGE_DEFAULT no .env
          - **Instala√ß√£o Bil√≠ngue**: Sele√ß√£o de idioma durante setup
          - **P√°gina de Sucesso**: Interface de conclus√£o em portugu√™s e ingl√™s
          - **Corre√ß√£o Autom√°tica**: Template .env corrigido durante atualiza√ß√µes

          ### üîß Sistema de Plugins V2:
          - **Detec√ß√£o Din√¢mica**: Sistema autom√°tico de descoberta de Data.json
          - **Templates Automatizados**: Scripts prontos para desenvolvimento de plugins
          - **Rastreio de Origem**: Inje√ß√£o autom√°tica de slug em todas as tabelas
          - **Resolu√ß√£o Din√¢mica**: Environment.json din√¢mico em todos os scripts
          - **Estrutura Moderna**: Arquitetura V2 para desenvolvimento Conn2Flow

          ### üéØ Recursos de Desenvolvimento:
          - Scripts de deploy automatizado em `ai-workspace/scripts/projects/`
          - Templates completos em `dev-plugins/plugins/templates/`
          - Scripts automatizados de commit, release e workflows
          - Resolu√ß√£o din√¢mica do environment.json
          - Compatibilidade com qualquer reposit√≥rio de plugin
          - Documenta√ß√£o abrangente incluindo sistema de deploy

          ### üîß Como usar:
          1. Use o [Conn2Flow Installer v1.5.0+](https://github.com/otavioserra/conn2flow/releases) para instala√ß√£o autom√°tica
          2. Para instala√ß√£o manual, use o instalador web em `gestor-instalador/index.php`
          3. Selecione o idioma desejado durante a instala√ß√£o (pt-br/en)
          4. Explore o novo sistema de templates visual no admin-paginas e admin-templates com interface de cards
          5. Utilize a biblioteca editor HTML centralizada para edi√ß√£o unificada em todos os m√≥dulos
          6. Configure tokens OAuth no environment.json para API de deploy (mantido da v2.4.0)
          7. Explore o sistema de IA integrado no admin-paginas para gera√ß√£o assistida de conte√∫do (mantido da v2.4.0)

          ### üìã Requisitos:
          - PHP 8.1+
          - MySQL 5.7+ ou MariaDB 10.2+
          - Extens√µes: zip, curl, mbstring, openssl, pdo_mysql
          - Git (para desenvolvimento de plugins e deploy)
        draft: false
        prerelease: false
        files: |
          gestor.zip
          gestor.zip.sha256
