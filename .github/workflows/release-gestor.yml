name: Release Gestor

on:
  push:
    tags:
      - 'gestor-v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: zip, curl, mbstring, openssl
        
    - name: Install Composer dependencies
      run: |
        cd gestor
        composer install --no-dev --optimize-autoloader --no-interaction
        
    - name: Generate Resources Updates
      run: |
        cd gestor/controladores/agents/arquitetura
        php atualizacao-dados-recursos.php
        echo "Resource updates generated successfully"

    - name: Commit Resources Updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add gestor/db/data/*.json
        git add gestor/db/orphans/*.json
        git add gestor/resources/*
        git add gestor/modulos/*/*.json
        git diff --cached --quiet || git commit -m "Auto-update resources for release ${{ github.ref_name }}"
        
    - name: Remove resource files
      run: |
        # Remove all resource files and directory to make installation lighter
        rm -rf gestor/resources/ && rmdir gestor/resources/ 2>/dev/null || true
        
        # Remove module resource files recursively
        find gestor/modulos -type d -name "resources" -exec rm -rf {} + || true
        
        echo "All resource files removed from release"
        
    - name: Create gestor.zip + checksum
      run: |
        # Remove arquivos desnecessÃ¡rios se existirem
        rm -rf gestor/.git* || true
        rm -rf gestor/vendor/bin/.phpunit* || true
        rm -rf gestor/vendor/composer/tmp-* || true

        # Remover somente .env sensÃ­veis da raiz (preservar templates em autenticacoes.exemplo)
        find gestor -maxdepth 1 -type f -name '.env*' -exec rm -f {} + 2>/dev/null || true
        # Remover .env internos reais de autenticacoes, exceto os de templates
        if [ -d gestor/autenticacoes ]; then
          find gestor/autenticacoes -type f -name '.env*' -not -path '*/autenticacoes.exemplo/*' -exec rm -f {} + 2>/dev/null || true
        fi

        # Criar o arquivo ZIP (resource files already removed)
        cd gestor
        zip -r ../gestor.zip . \
          -x "*.git*" \
          -x "vendor/bin/.phpunit*" \
          -x "vendor/composer/tmp-*" \
          -x "node_modules/*" \
          -x "*.DS_Store*" \
          -x "*.log*" \
          -x "tests/*" \
          -x "phpunit.xml*" \
          -x "resources/*" \
          -x "modulos/*/resources/*"
        cd ..
        sha256sum gestor.zip | awk '{print $1}' > gestor.zip.sha256

    - name: Get tag name
      id: tag
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.TAG_NAME }}
        name: "Gestor ${{ steps.tag.outputs.TAG_NAME }}"
        body: |
          ## ğŸš€ Conn2Flow Gestor Release v2.1.0 (Sistema de Plugins V2 + Arquitetura Refatorada)
          
          Esta release traz uma **revoluÃ§Ã£o completa no sistema de plugins** com arquitetura V2, templates automatizados e rastreio completo de dados.
          
          ### ğŸ¯ Novidades Principais desta VersÃ£o:
          - âœ… **Sistema de Plugins V2**: Arquitetura completamente refatorada com detecÃ§Ã£o dinÃ¢mica
          - âœ… **Templates de Desenvolvimento Automatizados**: Scripts padronizados para criaÃ§Ã£o de plugins
          - âœ… **Rastreio Completo de Origem**: InjeÃ§Ã£o automÃ¡tica de slug em tabelas com coluna plugin
          - âœ… **ResoluÃ§Ã£o DinÃ¢mica de Ambiente**: Environment.json dinÃ¢mico em todos os scripts
          - âœ… **Estrutura de Plugins Modernizada**: Nova arquitetura para desenvolvimento Conn2Flow
          - âœ… **Sistema de CorreÃ§Ãµes CrÃ­ticas**: CorreÃ§Ãµes importantes no sistema de plugins
          
          ### ğŸ”§ Melhorias TÃ©cnicas:
          - âœ… **MigraÃ§Ã£o para IDs Textuais**: Campos de referÃªncia convertidos para formato textual
          - âœ… **Scripts de AutomaÃ§Ã£o Padronizados**: ResoluÃ§Ã£o dinÃ¢mica em todos os scripts
          - âœ… **Arquitetura de Plugins Refatorada**: Sistema V2 com detecÃ§Ã£o automÃ¡tica
          - âœ… **Timezone Corrigido**: Ajuste para America/Sao_Paulo no Docker
          - âœ… **Compatibilidade Cross-Platform**: Scripts funcionam em qualquer repositÃ³rio
          - âœ… **Limpeza Ampla do Sistema**: DesabilitaÃ§Ã£o de ferramentas legadas
          
          ### ğŸ“¦ ConteÃºdo:
          - Sistema gestor completo com arquitetura hÃ­brida multilÃ­ngue
          - Sistema de plugins V2 com templates automatizados
          - Migrations para rastreio completo de dados (coluna plugin)
          - Sistema de atualizaÃ§Ã£o automÃ¡tica consolidado (v1.15.0)
          - 264+ recursos organizados por idioma (pt-br base)
          - DependÃªncias do Composer otimizadas
          - DocumentaÃ§Ã£o tÃ©cnica completa
          
          ### ğŸ”§ Sistema de Plugins V2:
          - **DetecÃ§Ã£o DinÃ¢mica**: Sistema automÃ¡tico de descoberta de Data.json
          - **Templates Automatizados**: Scripts prontos para desenvolvimento de plugins
          - **Rastreio de Origem**: InjeÃ§Ã£o automÃ¡tica de slug em todas as tabelas
          - **ResoluÃ§Ã£o DinÃ¢mica**: Environment.json dinÃ¢mico em todos os scripts
          - **Estrutura Moderna**: Arquitetura V2 para desenvolvimento Conn2Flow
          - **CorreÃ§Ãµes CrÃ­ticas**: Sistema robusto com correÃ§Ãµes importantes
          
          ### ğŸ¯ Recursos de Desenvolvimento:
          - Templates completos em `dev-plugins/plugins/templates/`
          - Scripts automatizados de commit, release e workflows
          - ResoluÃ§Ã£o dinÃ¢mica do environment.json
          - Compatibilidade com qualquer repositÃ³rio de plugin
          - DocumentaÃ§Ã£o abrangente para desenvolvimento
          
          ### ğŸ”§ Como usar:
          1. Use o [Conn2Flow Installer v1.4.1+](https://github.com/otavioserra/conn2flow/releases) para instalaÃ§Ã£o automÃ¡tica
          2. Para instalaÃ§Ã£o manual, use o instalador web em `gestor-instalador/index.php`
          3. Utilize os templates em `dev-plugins/plugins/templates/` para criar novos plugins
          
          ### ğŸ“‹ Requisitos:
          - PHP 8.1+
          - MySQL 5.7+ ou MariaDB 10.2+
          - ExtensÃµes: zip, curl, mbstring, openssl, pdo_mysql
          - Git (para desenvolvimento de plugins)
          
          ### ğŸŒŸ PadrÃµes Aprendidos e Implementados:
          - âœ… **Plugins V2**: Arquitetura moderna com detecÃ§Ã£o dinÃ¢mica
          - âœ… **Templates Automatizados**: Scripts padronizados para desenvolvimento
          - âœ… **Rastreio Completo**: InjeÃ§Ã£o automÃ¡tica de origem em tabelas
          - âœ… **ResoluÃ§Ã£o DinÃ¢mica**: Environment.json dinÃ¢mico e robusto
          - âœ… **IDs Textuais**: MigraÃ§Ã£o completa para formato textual
          - âœ… **Cross-Platform**: Compatibilidade universal de scripts
          
          ### ğŸ‰ Melhorias desta versÃ£o:
          - âœ… **Sistema de Plugins RevolucionÃ¡rio**: Arquitetura V2 completa e moderna
          - âœ… **Desenvolvimento Facilitado**: Templates automatizados e documentaÃ§Ã£o
          - âœ… **Rastreabilidade Total**: Sistema completo de origem de dados
          - âœ… **AutomaÃ§Ã£o Completa**: Scripts dinÃ¢micos e robustos
          - âœ… **Arquitetura Moderna**: IDs textuais e estrutura refatorada
          - âœ… **Compatibilidade Preservada**: Zero breaking changes para usuÃ¡rios finais
          
          ### âš ï¸ Breaking Changes (Migration Guide):
          - Campos de referÃªncia de mÃ³dulos migrados para formato textual
          - Scripts de automaÃ§Ã£o padronizados com resoluÃ§Ã£o dinÃ¢mica
          - Arquitetura de plugins modernizada (V2)
          - Timezone ajustado para America/Sao_Paulo
          
          ### ğŸ”„ Migration Path:
          1. Use o instalador web para atualizaÃ§Ã£o automÃ¡tica
          2. Ou execute: `php controladores/atualizacoes/atualizacoes-banco-de-dados.php --env-dir=seu-dominio`
          3. Atualize scripts de plugins para usar resoluÃ§Ã£o dinÃ¢mica
          4. Utilize os novos templates para desenvolvimento
          5. Aproveite a arquitetura V2 de plugins
        draft: false
        prerelease: false
        files: |
          gestor.zip
          gestor.zip.sha256
