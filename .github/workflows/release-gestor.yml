name: Release Gestor

on:
  push:
    tags:
      - 'gestor-v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: zip, curl, mbstring, openssl
        
    - name: Install Composer dependencies
      run: |
        cd gestor
        composer install --no-dev --optimize-autoloader --no-interaction
        
    - name: Generate Resources Updates
      run: |
        cd gestor/controladores/agents/arquitetura
        php atualizacao-dados-recursos.php
        echo "Resource updates generated successfully"

    - name: Commit Resources Updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add gestor/db/data/*.json
        git add gestor/db/orphans/*.json
        git add gestor/resources/*
        git add gestor/modulos/*/*.json
        git diff --cached --quiet || git commit -m "Auto-update resources for release ${{ github.ref_name }}"
        
    - name: Remove resource files
      run: |
        # Remove all resource files and directory to make installation lighter
        rm -rf gestor/resources/ && rmdir gestor/resources/ 2>/dev/null || true
        
        # Remove module resource files recursively
        find gestor/modulos -type d -name "resources" -exec rm -rf {} + || true
        
        echo "All resource files removed from release"
        
    - name: Create gestor.zip + checksum
      run: |
        # Remove arquivos desnecessÃ¡rios se existirem
        rm -rf gestor/.git* || true
        rm -rf gestor/vendor/bin/.phpunit* || true
        rm -rf gestor/vendor/composer/tmp-* || true

        # Remover somente .env sensÃ­veis da raiz (preservar templates em autenticacoes.exemplo)
        find gestor -maxdepth 1 -type f -name '.env*' -exec rm -f {} + 2>/dev/null || true
        # Remover .env internos reais de autenticacoes, exceto os de templates
        if [ -d gestor/autenticacoes ]; then
          find gestor/autenticacoes -type f -name '.env*' -not -path '*/autenticacoes.exemplo/*' -exec rm -f {} + 2>/dev/null || true
        fi

        # Criar o arquivo ZIP (resource files already removed)
        cd gestor
        zip -r ../gestor.zip . \
          -x "*.git*" \
          -x "vendor/bin/.phpunit*" \
          -x "vendor/composer/tmp-*" \
          -x "node_modules/*" \
          -x "*.DS_Store*" \
          -x "*.log*" \
          -x "tests/*" \
          -x "phpunit.xml*" \
          -x "resources/*" \
          -x "modulos/*/resources/*"
        cd ..
        sha256sum gestor.zip | awk '{print $1}' > gestor.zip.sha256

    - name: Get tag name
      id: tag
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.TAG_NAME }}
        name: "Gestor ${{ steps.tag.outputs.TAG_NAME }}"
        body: |
          ## ğŸš€ Conn2Flow Gestor Release v2.0.X (Sistema de Preview + Framework CSS)
          
          Esta release traz **grandes melhorias nos mÃ³dulos administrativos** com sistema de preview TailwindCSS e suporte multi-framework CSS.
          
          ### ğŸ¯ Novidades Principais desta VersÃ£o:
          - âœ… **Sistema de Preview TailwindCSS**: PrÃ©-visualizaÃ§Ã£o em tempo real para layouts, pÃ¡ginas e componentes
          - âœ… **Suporte Multi-Framework CSS**: Escolha entre TailwindCSS e FomanticUI por recurso
          - âœ… **MÃ³dulos Admin Modernizados**: admin-layouts, admin-paginas e admin-componentes com interface melhorada
          - âœ… **Sistema de Modal AvanÃ§ado**: Modals responsivos com CodeMirror integrado
          - âœ… **Ordem de DependÃªncias Otimizada**: ResoluÃ§Ã£o de problemas de inicializaÃ§Ã£o DOM
          - âœ… **ValidaÃ§Ã£o de Framework CSS**: Campo obrigatÃ³rio para recursos visuais
          
          ### ğŸ”§ Melhorias TÃ©cnicas:
          - âœ… **gestor_componente() Corrigido**: Uso adequado sem parÃ¢metro 'variaveis'
          - âœ… **modelo_var_troca() Individual**: SubstituiÃ§Ãµes precisas de placeholders
          - âœ… **Endpoints de Preview**: Sistema robusto para geraÃ§Ã£o de HTML em tempo real
          - âœ… **JavaScript Otimizado**: FunÃ§Ãµes de callback para botÃµes personalizados
          - âœ… **PadrÃµes Documentados**: Template atualizado para novos mÃ³dulos
          
          ### ğŸ“¦ ConteÃºdo:
          - Sistema gestor completo com arquitetura hÃ­brida multilÃ­ngue
          - Migrations para suporte framework_css (campo VARCHAR(50))
          - Sistema de atualizaÃ§Ã£o automÃ¡tica consolidado (v1.15.0)
          - 264 recursos organizados por idioma (pt-br base)
          - DependÃªncias do Composer otimizadas
          - DocumentaÃ§Ã£o tÃ©cnica completa
          
          ### ğŸ”§ MÃ³dulos Administrativos Atualizados:
          - **admin-layouts**: Preview TailwindCSS + validaÃ§Ã£o framework_css
          - **admin-componentes**: Sistema modal otimizado + CodeMirror
          - **admin-paginas**: ReferÃªncia de padrÃµes corretos implementados
          
          ### ğŸ¯ Sistema de Preview:
          - Modal de prÃ©-visualizaÃ§Ã£o responsivo
          - Suporte TailwindCSS via CDN
          - Fallback FomanticUI automÃ¡tico
          - Iframe isolado para renderizaÃ§Ã£o
          - Callback JavaScript personalizado
          
          ### ğŸ”§ Como usar:
          1. Use o [Conn2Flow Installer v1.4.0+](https://github.com/otavioserra/conn2flow/releases) para instalaÃ§Ã£o automÃ¡tica
          2. Ou extraia manualmente e execute: `php phinx.php migrate && php phinx.php seed:run`
          3. Aproveite os novos recursos de preview nos mÃ³dulos administrativos
          
          ### ğŸ“‹ Requisitos:
          - PHP 8.1+
          - MySQL 5.7+ ou MariaDB 10.2+
          - ExtensÃµes: zip, curl, mbstring, openssl, pdo_mysql
          - Acesso Ã  internet (para TailwindCSS CDN no preview)
          
          ### ğŸŒŸ PadrÃµes Aprendidos e Implementados:
          - âœ… **Ordem CrÃ­tica**: Modal ANTES do CodeMirror nas dependÃªncias
          - âœ… **Componentes**: gestor_componente() retorna HTML que precisa de modelo_var_troca()
          - âœ… **Frameworks**: Campo framework_css obrigatÃ³rio para recursos visuais
          - âœ… **Preview**: Endpoints PHP + JavaScript para prÃ©-visualizaÃ§Ã£o
          - âœ… **ValidaÃ§Ã£o**: FormulÃ¡rios com validaÃ§Ã£o de framework CSS
          
          ### ğŸ‰ Melhorias desta versÃ£o:
          - âœ… **Interface moderna**: Sistema de preview intuitivo e responsivo
          - âœ… **Flexibilidade CSS**: Escolha livre entre frameworks por recurso
          - âœ… **Desenvolvimento facilitado**: PadrÃµes claros para novos mÃ³dulos
          - âœ… **AdministraÃ§Ã£o melhorada**: Interface mais rica e funcional
          - âœ… **DocumentaÃ§Ã£o completa**: Guias tÃ©cnicos para desenvolvedores
          - âœ… **Compatibilidade preservada**: Zero breaking changes para usuÃ¡rios finais
        draft: false
        prerelease: false
        files: |
          gestor.zip
          gestor.zip.sha256
