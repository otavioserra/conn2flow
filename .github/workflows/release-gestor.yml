name: Release Gestor

on:
  push:
    tags:
      - 'gestor-v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: zip, curl, mbstring, openssl
        
    - name: Install Composer dependencies
      run: |
        cd gestor
        composer install --no-dev --optimize-autoloader --no-interaction
        
    - name: Generate Resources Updates
      run: |
        cd gestor/controladores/agents/arquitetura
        php atualizacao-dados-recursos.php
        echo "Resource updates generated successfully"

    - name: Commit Resources Updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add gestor/db/data/*.json
        git add gestor/db/orphans/*.json
        git add gestor/resources/*
        git add gestor/modulos/*/*.json
        git diff --cached --quiet || git commit -m "Auto-update resources for release ${{ github.ref_name }}"
        
    - name: Remove resource files
      run: |
        # Remove all resource files and directory to make installation lighter
        rm -rf gestor/resources/ && rmdir gestor/resources/ 2>/dev/null || true
        
        # Remove module resource files recursively
        find gestor/modulos -type d -name "resources" -exec rm -rf {} + || true
        
        echo "All resource files removed from release"
        
    - name: Create gestor.zip + checksum
      run: |
        # Remove arquivos desnecessÃ¡rios se existirem
        rm -rf gestor/.git* || true
        rm -rf gestor/vendor/bin/.phpunit* || true
        rm -rf gestor/vendor/composer/tmp-* || true

        # Criar o arquivo ZIP (resource files already removed)
        cd gestor
        zip -r ../gestor.zip . \
          -x "*.git*" \
          -x "vendor/bin/.phpunit*" \
          -x "vendor/composer/tmp-*" \
          -x "node_modules/*" \
          -x "*.DS_Store*" \
          -x "*.log*" \
          -x "tests/*" \
          -x ".env*" \
          -x "phpunit.xml*" \
          -x "resources/*" \
          -x "modulos/*/resources/*"
        cd ..
        sha256sum gestor.zip | awk '{print $1}' > gestor.zip.sha256

    - name: Get tag name
      id: tag
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.TAG_NAME }}
        name: "Gestor ${{ steps.tag.outputs.TAG_NAME }}"
        body: |
          ## ğŸŒ Conn2Flow Gestor Release (Sistema HÃ­brido MultilÃ­ngue v1.8.4+)
          
          Esta release contÃ©m o sistema gestor completo do Conn2Flow com o **novo sistema hÃ­brido multilÃ­ngue**.
          
          ### ğŸ“¦ ConteÃºdo:
          - Sistema gestor completo com arquitetura hÃ­brida multilÃ­ngue
          - Migrations para tabelas multilÃ­ngues (layouts, pages, components)
          - Seeders gerados dinamicamente com 264 recursos em pt-br
          - Sistema preparado para mÃºltiplos idiomas (pt-br, en, es, etc.)
          - 343 arquivos HTML/CSS organizados via seeders
          - DependÃªncias do Composer otimizadas
          
          ### ğŸ”§ Novidades desta versÃ£o:
          - âœ… **Sistema hÃ­brido multilÃ­ngue**: Recursos organizados por idioma
          - âœ… **InstalaÃ§Ã£o ultra-leve**: 343 arquivos fÃ­sicos convertidos em seeders
          - âœ… **Modular escalÃ¡vel**: 88 recursos globais + 173 modulares + 10 plugins
          - âœ… **MultilÃ­ngue nativo**: Campo 'language' em todas as tabelas
          - âœ… **Versionamento automÃ¡tico**: Checksums MD5 para cada recurso
          - âœ… **Seeders dinÃ¢micos**: 21 layouts + 135 pÃ¡ginas + 108 componentes
          
          ### ğŸ¯ DistribuiÃ§Ã£o de Recursos:
          - ğŸŒ **Recursos Globais**: 32.5% (88 recursos)
          - ğŸ§© **Recursos Modulares**: 63.8% (173 recursos)
          - ğŸ”Œ **Recursos Plugins**: 3.7% (10 recursos)
          
          ### ğŸ”§ Como usar:
          1. Use o [Conn2Flow Installer](https://github.com/otavioserra/conn2flow/releases) para instalaÃ§Ã£o automÃ¡tica
          2. Ou extraia manualmente e execute: `php phinx.php migrate && php phinx.php seed:run`
          
          ### ğŸ“‹ Requisitos:
          - PHP 8.1+
          - MySQL 5.7+ ou MariaDB 10.2+
          - ExtensÃµes: zip, curl, mbstring, openssl, pdo_mysql
          
          ### ï¿½ PreparaÃ§Ã£o MultilÃ­ngue:
          - âœ… Estrutura `pt-br` completamente implementada
          - âœ… Pronto para `en`, `es` e outros idiomas
          - âœ… Campo `language` em todas as tabelas
          - âœ… Ãndices otimizados para consultas multilÃ­ngues
          
          ### ğŸ‰ Melhorias desta versÃ£o:
          - âœ… **OrganizaÃ§Ã£o perfeita**: 100% dos recursos na estrutura correta
          - âœ… **Zero arquivos Ã³rfÃ£os**: Limpeza completa do sistema
          - âœ… **Desenvolvimento facilitado**: Devs editam arquivos fÃ­sicos
          - âœ… **AdministraÃ§Ã£o simplificada**: Admins customizam via painel
          - âœ… **Deploy automatizado**: GitHub Actions + seeders automÃ¡ticos
          - âœ… **Escalabilidade garantida**: Preparado para crescimento
        draft: false
        prerelease: false
        files: |
          gestor.zip
          gestor.zip.sha256
