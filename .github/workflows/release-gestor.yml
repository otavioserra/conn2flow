name: Release Gestor

on:
  push:
    tags:
      - 'gestor-v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: zip, curl, mbstring, openssl
        
    - name: Install Composer dependencies
      run: |
        cd gestor
        composer install --no-dev --optimize-autoloader --no-interaction
        
    - name: Generate Resources Updates
      run: |
        cd gestor/controladores/agents/arquitetura
        php atualizacao-dados-recursos.php
        echo "Resource updates generated successfully"

    - name: Commit Resources Updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add gestor/db/data/*.json
        git add gestor/db/orphans/*.json
        git add gestor/resources/*
        git add gestor/modulos/*/*.json
        git diff --cached --quiet || git commit -m "Auto-update resources for release ${{ github.ref_name }}"
        
    - name: Remove resource files
      run: |
        # Remove all resource files and directory to make installation lighter
        rm -rf gestor/resources/ && rmdir gestor/resources/ 2>/dev/null || true
        
        # Remove module resource files recursively
        find gestor/modulos -type d -name "resources" -exec rm -rf {} + || true
        
        echo "All resource files removed from release"
        
    - name: Create gestor.zip + checksum
      run: |
        # Remove arquivos desnecess√°rios se existirem
        rm -rf gestor/.git* || true
        rm -rf gestor/vendor/bin/.phpunit* || true
        rm -rf gestor/vendor/composer/tmp-* || true

        # Remover somente .env sens√≠veis da raiz (preservar templates em autenticacoes.exemplo)
        find gestor -maxdepth 1 -type f -name '.env*' -exec rm -f {} + 2>/dev/null || true
        # Remover .env internos reais de autenticacoes, exceto os de templates
        if [ -d gestor/autenticacoes ]; then
          find gestor/autenticacoes -type f -name '.env*' -not -path '*/autenticacoes.exemplo/*' -exec rm -f {} + 2>/dev/null || true
        fi

        # Criar o arquivo ZIP (resource files already removed)
        cd gestor
        zip -r ../gestor.zip . \
          -x "*.git*" \
          -x "vendor/bin/.phpunit*" \
          -x "vendor/composer/tmp-*" \
          -x "node_modules/*" \
          -x "*.DS_Store*" \
          -x "*.log*" \
          -x "tests/*" \
          -x "phpunit.xml*" \
          -x "resources/*" \
          -x "modulos/*/resources/*"
        cd ..
        sha256sum gestor.zip | awk '{print $1}' > gestor.zip.sha256

    - name: Get tag name
      id: tag
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.TAG_NAME }}
        name: "Gestor ${{ steps.tag.outputs.TAG_NAME }}"
        body: |
          ## üöÄ Conn2Flow Gestor Release v2.6.0 (M√≥dulo Publisher + Editor Quill + Clonagem + Image Picker)

          Esta vers√£o traz o **novo m√≥dulo Publisher completo** com editor Quill WYSIWYG, sistema de campos din√¢micos, funcionalidade de clonagem e seletor visual de imagens no editor HTML, al√©m de manter todas as funcionalidades do sistema de IA integrado, deploy OAuth e arquitetura multil√≠ngue.

          ### üéØ Novidades Principais desta Vers√£o:
          - ‚úÖ **M√≥dulo Publisher Completo**: Novo m√≥dulo de publica√ß√£o de conte√∫do com CRUD completo para publishers e p√°ginas
          - ‚úÖ **Editor Quill WYSIWYG**: Integra√ß√£o profissional do editor Quill para edi√ß√£o rica de conte√∫do
          - ‚úÖ **Sistema de Campos Din√¢micos**: Campos configur√°veis para templates de publisher com tipos variados
          - ‚úÖ **Templates Abstratos de Not√≠cias**: Templates prontos para uso gerados por IA e revisados
          - ‚úÖ **Funcionalidade de Clonagem**: Clone r√°pido de p√°ginas admin, templates admin e p√°ginas do publisher
          - ‚úÖ **Image Picker no Editor HTML**: Seletor visual de imagens integrado ao editor com preview em grid
          - ‚úÖ **Modo de Simula√ß√£o de Design**: Dropdown para simular diferentes modos de design no editor HTML
          - ‚úÖ **Tooltips nos Bot√µes do Editor**: Tooltips informativos nos bot√µes de template e campos
          - ‚úÖ **Modifica√ß√£o de Se√ß√µes no Editor**: Funcionalidades avan√ßadas de modifica√ß√£o de se√ß√£o visual
          - ‚úÖ **Fomantic-UI v2.9.4**: Atualiza√ß√£o para a √∫ltima vers√£o do framework CSS
          - ‚úÖ **Modelos Gemini Atualizados**: Atualiza√ß√£o das vers√µes dos modelos nos prompts de IA
          - ‚úÖ **Detec√ß√£o de Linguagem Aprimorada**: Prioridade para detec√ß√£o do browser sobre padr√£o do sistema
          - ‚úÖ **Sistema de M√∫ltiplos Modais**: Suporte a modais empilhados com `allowMultiple: true`
          - ‚úÖ **Biblioteca Editor HTML Centralizada**: Nova biblioteca `html-editor.php` (mantido da v2.5.0)
          - ‚úÖ **Sistema de Templates Visual**: Interface com cards Fomantic UI (mantido da v2.5.0)
          - ‚úÖ **Sistema Completo de Deploy via OAuth**: Deploy automatizado com OAuth 2.0 (mantido da v2.4.0)
          - ‚úÖ **Sistema de IA Integrado**: Gera√ß√£o de conte√∫do via API Gemini (mantido da v2.4.0)
          - ‚úÖ **Sistema Multil√≠ngue Completo**: Suporte pt-br/en (mantido da v2.4.0)
          - ‚úÖ **Sistema de Plugins V2**: Arquitetura refatorada (mantido da v2.4.0)

          ### üîß Melhorias T√©cnicas:
          - ‚úÖ **Novo M√≥dulo Publisher**: CRUD completo com defini√ß√µes, p√°ginas e templates
          - ‚úÖ **Editor Quill Integrado**: Edi√ß√£o rica de conte√∫do com formata√ß√£o avan√ßada
          - ‚úÖ **Sistema de Campos Din√¢micos**: Vincula√ß√£o de campos com templates de publisher
          - ‚úÖ **Funcionalidade de Clonagem**: Clone para admin-paginas, admin-templates e publisher-paginas
          - ‚úÖ **Image Picker com postMessage**: Comunica√ß√£o iframe ‚Üî parent para sele√ß√£o de imagens
          - ‚úÖ **Suporte a M√∫ltiplos Modais**: `allowMultiple: true` no Fomantic-UI
          - ‚úÖ **M√≥dulos Virtuais**: M√≥dulos sem backend para controle de acesso simplificado
          - ‚úÖ **Snippets AJAX**: Integra√ß√£o de contextos de agentes para chat
          - ‚úÖ **Gloss√°rio de Vari√°veis Globais**: Documenta√ß√£o para componentes IA
          - ‚úÖ **Campos 'notEmpty'**: Migra√ß√£o de 'empty' para futura descontinua√ß√£o Fomantic-UI

          ### üì¶ Conte√∫do:
          - Sistema gestor completo com m√≥dulo Publisher e editor Quill
          - Funcionalidade de clonagem para p√°ginas e templates
          - Image picker integrado ao editor HTML visual
          - Biblioteca `html-editor.php` com componentes reutiliz√°veis
          - Sistema de sele√ß√£o de templates com interface de cards
          - Scripts de deploy automatizado
          - Biblioteca ia.php para opera√ß√µes de IA e OAuth
          - Sistema de plugins V2 com templates automatizados
          - Migrations para m√≥dulo publisher e campos din√¢micos
          - Sistema de atualiza√ß√£o autom√°tica consolidado
          - Recursos organizados por idioma (pt-br base)
          - Instalador multil√≠ngue com sele√ß√£o de idioma
          - Depend√™ncias do Composer otimizadas
          - Documenta√ß√£o t√©cnica completa

          ### üì∞ M√≥dulo Publisher:
          - **CRUD Completo**: Gerenciamento de publishers (defini√ß√µes) e p√°ginas
          - **Editor Quill WYSIWYG**: Edi√ß√£o rica com formata√ß√£o avan√ßada
          - **Sistema de Campos Din√¢micos**: Campos configur√°veis por template
          - **Templates Abstratos**: Templates prontos (ex: not√≠cias) gerados por IA
          - **Clonagem de P√°ginas**: Duplica√ß√£o r√°pida de conte√∫do existente
          - **Integra√ß√£o com Sistema IA**: Gera√ß√£o assistida de conte√∫do

          ### üé® Editor HTML Visual:
          - **Image Picker Integrado**: Seletor visual de imagens com preview em grid
          - **M√∫ltiplos Modais**: Suporte a modais empilhados (preview + imagepick)
          - **Modo de Simula√ß√£o**: Dropdown para simular diferentes designs
          - **Tooltips Informativos**: Dicas nos bot√µes de template e campos
          - **Modifica√ß√£o de Se√ß√µes**: Funcionalidades avan√ßadas de edi√ß√£o de se√ß√£o

          ### üöÄ Sistema de Deploy de Projetos:
          - **API OAuth 2.0**: Autentica√ß√£o obrigat√≥ria com renova√ß√£o autom√°tica
          - **Deploy One-Click**: Atualiza√ß√£o ‚Üí compress√£o ‚Üí upload ‚Üí processamento
          - **Valida√ß√£o Robusta**: ZIP seguro com detec√ß√£o de estrutura
          - **Execu√ß√£o Inline**: Banco atualizado sem shell_exec

          ### ü§ñ Sistema de IA:
          - **Integra√ß√£o Gemini API**: Comunica√ß√£o com IA do Google
          - **Sistema Dual de Prompts**: Modos t√©cnicos + necessidades do usu√°rio
          - **Interface Avan√ßada**: CodeMirror com inser√ß√£o posicional
          - **Modelos Atualizados**: Vers√µes recentes do Gemini

          ### üåê Sistema Multil√≠ngue:
          - **Interface Administrativa**: Seletor de idioma no admin-environment
          - **Detec√ß√£o de Browser**: Prioridade para idioma do navegador
          - **Instala√ß√£o Bil√≠ngue**: Sele√ß√£o de idioma durante setup

          ### üîß Como usar:
          1. Use o [Conn2Flow Installer v1.5.0+](https://github.com/otavioserra/conn2flow/releases)
          2. Para instala√ß√£o manual, use `gestor-instalador/index.php`
          3. Selecione o idioma desejado (pt-br/en)
          4. Explore o novo m√≥dulo Publisher para publica√ß√£o de conte√∫do
          5. Use o editor Quill para edi√ß√£o rica de conte√∫do
          6. Utilize a funcionalidade de clonagem para duplicar p√°ginas e templates
          7. Experimente o image picker no editor HTML visual

          ### üìã Requisitos:
          - PHP 8.1+
          - MySQL 5.7+ ou MariaDB 10.2+
          - Extens√µes: zip, curl, mbstring, openssl, pdo_mysql
          - Git (para desenvolvimento de plugins e deploy)
        draft: false
        prerelease: false
        files: |
          gestor.zip
          gestor.zip.sha256
