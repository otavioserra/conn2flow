name: Release Gestor

on:
  push:
    tags:
      - 'gestor-v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: zip, curl, mbstring, openssl
        
    - name: Install Composer dependencies
      run: |
        cd gestor
        composer install --no-dev --optimize-autoloader
        
    - name: Create gestor.zip
      run: |
        # Remove arquivos desnecessÃ¡rios
        rm -rf gestor/.git*
        rm -rf gestor/vendor/bin/.phpunit
        rm -rf gestor/vendor/composer/tmp-*
        
        # Criar o arquivo ZIP
        cd gestor
        zip -r ../gestor.zip . \
          -x "*.git*" \
          -x "vendor/bin/.phpunit*" \
          -x "vendor/composer/tmp-*" \
          -x "node_modules/*" \
          -x "*.DS_Store*" \
          -x "*.log*"
          
    - name: Get tag name
      id: tag
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.TAG_NAME }}
        name: "Gestor ${{ steps.tag.outputs.TAG_NAME }}"
        body: |
          ## ðŸš€ Conn2Flow Gestor Release
          
          Esta release contÃ©m o sistema gestor completo do Conn2Flow.
          
          ### ðŸ“¦ ConteÃºdo:
          - Sistema gestor completo
          - 75 migraÃ§Ãµes de banco de dados
          - 14 seeders com dados iniciais
          - Schema SQL prÃ©-gerado para fallback
          - DependÃªncias do Composer otimizadas
          
          ### ðŸ”§ Como usar:
          1. Use o [Conn2Flow Installer](https://github.com/otavioserra/conn2flow/releases) para instalaÃ§Ã£o automÃ¡tica
          2. Ou extraia manualmente e configure conforme documentaÃ§Ã£o
          
          ### ðŸ“‹ Requisitos:
          - PHP 8.2+
          - MySQL 5.7+ ou MariaDB 10.2+
          - ExtensÃµes: zip, curl, mbstring, openssl
        draft: false
        prerelease: false
        files: gestor.zip
