name: Release Gestor

on:
  push:
    tags:
      - 'gestor-v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: zip, curl, mbstring, openssl
        
    - name: Install Composer dependencies
      run: |
        cd gestor
        composer install --no-dev --optimize-autoloader --no-interaction
        
    - name: Generate Resources Updates
      run: |
        cd gestor/controladores/agents/arquitetura
        php atualizacao-dados-recursos.php
        echo "Resource updates generated successfully"

    - name: Commit Resources Updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add gestor/db/data/*.json
        git add gestor/db/orphans/*.json
        git add gestor/resources/*
        git add gestor/modulos/*/*.json
        git diff --cached --quiet || git commit -m "Auto-update resources for release ${{ github.ref_name }}"
        
    - name: Remove resource files
      run: |
        # Remove all resource files and directory to make installation lighter
        rm -rf gestor/resources/ && rmdir gestor/resources/ 2>/dev/null || true
        
        # Remove module resource files recursively
        find gestor/modulos -type d -name "resources" -exec rm -rf {} + || true
        
        echo "All resource files removed from release"
        
    - name: Create gestor.zip + checksum
      run: |
        # Remove arquivos desnecess√°rios se existirem
        rm -rf gestor/.git* || true
        rm -rf gestor/vendor/bin/.phpunit* || true
        rm -rf gestor/vendor/composer/tmp-* || true

        # Remover somente .env sens√≠veis da raiz (preservar templates em autenticacoes.exemplo)
        find gestor -maxdepth 1 -type f -name '.env*' -exec rm -f {} + 2>/dev/null || true
        # Remover .env internos reais de autenticacoes, exceto os de templates
        if [ -d gestor/autenticacoes ]; then
          find gestor/autenticacoes -type f -name '.env*' -not -path '*/autenticacoes.exemplo/*' -exec rm -f {} + 2>/dev/null || true
        fi

        # Criar o arquivo ZIP (resource files already removed)
        cd gestor
        zip -r ../gestor.zip . \
          -x "*.git*" \
          -x "vendor/bin/.phpunit*" \
          -x "vendor/composer/tmp-*" \
          -x "node_modules/*" \
          -x "*.DS_Store*" \
          -x "*.log*" \
          -x "tests/*" \
          -x "phpunit.xml*" \
          -x "resources/*" \
          -x "modulos/*/resources/*"
        cd ..
        sha256sum gestor.zip | awk '{print $1}' > gestor.zip.sha256

    - name: Get tag name
      id: tag
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.TAG_NAME }}
        name: "Gestor ${{ steps.tag.outputs.TAG_NAME }}"
        make_latest: true
        body: |
          ## üöÄ Conn2Flow Gestor Release v2.7.0 (M√≥dulo de Formul√°rios + Sistema Din√¢mico + reCAPTCHA + API de Atualiza√ß√£o)

          Esta vers√£o traz o **m√≥dulo completo de formul√°rios** com CRUD, submiss√µes, seguran√ßa via reCAPTCHA/FingerprintJS, sistema de formul√°rios din√¢micos totalmente refatorado, e **atualiza√ß√£o remota do sistema via API REST**, al√©m de manter todas as funcionalidades anteriores como menu responsivo, Publisher, IA integrada, deploy OAuth e arquitetura multil√≠ngue.

          ### üéØ Novidades Principais desta Vers√£o:
          - ‚úÖ **M√≥dulo de Formul√°rios Completo**: Gerenciamento de formul√°rios com CRUD, suporte multil√≠ngue (pt-br/en) e visualizador JSON via CodeMirror
          - ‚úÖ **M√≥dulo de Submiss√µes**: Processamento de submiss√µes com seguran√ßa, logs, bloqueios e notifica√ß√µes por email
          - ‚úÖ **Sistema de Formul√°rios Din√¢micos Refatorado**: Reescrita completa do `formulario.js` com componentes externalizados e localiza√ß√£o
          - ‚úÖ **Google reCAPTCHA V2 + V3**: Suporte a V2 no admin-environment + carregamento din√¢mico V3
          - ‚úÖ **FingerprintJS v4**: Fingerprinting robusto com m√∫ltiplas camadas de fallback
          - ‚úÖ **Componente Form UI**: Novo componente frontend com detec√ß√£o de framework e localiza√ß√£o
          - ‚úÖ **Atualiza√ß√£o do Sistema via API**: Endpoint `/_api/system/update` para atualiza√ß√µes remotas com OAuth 2.0
          - ‚úÖ **Script de Atualiza√ß√£o Automatizada**: Script bash com progresso, renova√ß√£o de token e logging
          - ‚úÖ **M√≥dulo de Contatos**: P√°ginas de contato com Fomantic UI e redirecionamentos
          - ‚úÖ **Componentes de Erro por Framework**: Fomantic UI, Bootstrap e outros
          - ‚úÖ **Menu Administrativo Responsivo**: Redesign completo com toggle e resize (mantido da v2.6.3)
          - ‚úÖ **M√≥dulo Publisher Completo**: Publica√ß√£o de conte√∫do com editor Quill (mantido da v2.6.0)
          - ‚úÖ **Sistema Completo de Deploy via OAuth**: Deploy automatizado com OAuth 2.0 (mantido da v2.4.0)
          - ‚úÖ **Sistema de IA Integrado**: Gera√ß√£o de conte√∫do via API Gemini (mantido da v2.4.0)
          - ‚úÖ **Sistema Multil√≠ngue Completo**: Suporte pt-br/en (mantido da v2.4.0)
          - ‚úÖ **Sistema de Plugins V2**: Arquitetura refatorada (mantido da v2.4.0)

          ### üîß Melhorias T√©cnicas:
          - ‚úÖ **Posicionamento de Erros**: Mensagens antes do bot√£o de submit clicado
          - ‚úÖ **Componentes Externalizados**: AJAX messages e block wrappers em arquivos separados
          - ‚úÖ **Corre√ß√£o de Ap√≥strofos**: Renderiza√ß√£o correta em campos de formul√°rio
          - ‚úÖ **Corre√ß√£o CodeMirror**: Removida duplica√ß√£o de inicializa√ß√£o no editor HTML
          - ‚úÖ **Corre√ß√£o sincronizarTabela**: Chave de par√¢metro 'module' ‚Üí 'modulo'
          - ‚úÖ **Tradu√ß√µes**: P√°gina oauth-authenticate traduzida para ingl√™s
          - ‚úÖ **WebP Thumbnails**: Templates de sess√£o atualizados para WebP
          - ‚úÖ **Documenta√ß√£o Extensa**: Agentes Copilot, arquitetura de plugins, PayPal v2.0.0

          ### üì¶ Conte√∫do:
          - Sistema gestor completo com m√≥dulo de formul√°rios
          - Sistema de submiss√µes com seguran√ßa reCAPTCHA + FingerprintJS
          - Sistema de formul√°rios din√¢micos refatorado com localiza√ß√£o
          - API REST para atualiza√ß√£o remota do sistema
          - Script de atualiza√ß√£o automatizada via API
          - M√≥dulo de contatos com formul√°rios Fomantic UI
          - Menu administrativo responsivo com suporte a tablets
          - Dashboard otimizado para tablets com layout de 2 colunas
          - M√≥dulo Publisher com editor Quill integrado
          - Funcionalidade de clonagem para p√°ginas e templates
          - Image picker integrado ao editor HTML visual
          - Biblioteca `html-editor.php` com componentes reutiliz√°veis
          - Scripts de deploy e atualiza√ß√£o automatizados
          - Biblioteca ia.php para opera√ß√µes de IA e OAuth
          - Sistema de plugins V2 com templates automatizados
          - Migrations para formul√°rios, submiss√µes e contatos
          - Sistema de atualiza√ß√£o autom√°tica consolidado
          - Recursos organizados por idioma (pt-br base)
          - Instalador multil√≠ngue com sele√ß√£o de idioma
          - Depend√™ncias do Composer otimizadas
          - Documenta√ß√£o t√©cnica completa

          ### üìã M√≥dulo de Formul√°rios:
          - **CRUD Completo**: Adicionar, listar, visualizar, editar e clonar formul√°rios
          - **Schema JSON**: Defini√ß√£o de campos via JSON com valida√ß√£o CodeMirror
          - **Suporte Multil√≠ngue**: P√°ginas e labels em pt-br e en
          - **Fomantic UI Interface**: Interface moderna com cards e tabelas estilizadas
          - **Submiss√µes**: Processamento com valida√ß√£o, seguran√ßa e logging

          ### üîí Seguran√ßa de Formul√°rios:
          - **reCAPTCHA V2**: Checkbox integration via admin-environment
          - **reCAPTCHA V3**: Carregamento din√¢mico com score-based validation
          - **FingerprintJS v4**: Device fingerprinting com fallback robusto
          - **Bloqueio de Submiss√µes**: Rate limiting e detec√ß√£o de spam
          - **Logs de Seguran√ßa**: Registro detalhado de todas as submiss√µes

          ### üîÑ Atualiza√ß√£o do Sistema via API:
          - **Endpoint REST**: `/_api/system/update` com autentica√ß√£o OAuth 2.0
          - **Workflow Multi-Step**: start ‚Üí deploy ‚Üí db ‚Üí finalize
          - **Script Automatizado**: `update-system.sh` com barra de progresso
          - **Modos de Atualiza√ß√£o**: full, only-files, only-db
          - **Dry-Run**: Simula√ß√£o sem aplicar mudan√ßas
          - **Renova√ß√£o Autom√°tica de Token**: Tratamento de 401 com retry

          ### üì± Menu Administrativo Responsivo:
          - **Bot√£o Toggle Flutuante**: Aparece quando menu est√° fechado
          - **Menu Redimension√°vel**: Arraste o handle para ajustar largura (200-450px)
          - **Sidebar Overlay em Mobile/Tablet**: Comportamento unificado at√© 1024px
          - **Atalho de Teclado**: Ctrl/Cmd+B para toggle do menu
          - **Persist√™ncia de Estado**: Largura e estado salvos em localStorage

          ### üì∞ M√≥dulo Publisher:
          - **CRUD Completo**: Gerenciamento de publishers (defini√ß√µes) e p√°ginas
          - **Editor Quill WYSIWYG**: Edi√ß√£o rica com formata√ß√£o avan√ßada
          - **Sistema de Campos Din√¢micos**: Campos configur√°veis por template
          - **Templates Abstratos**: Templates prontos (ex: not√≠cias) gerados por IA
          - **Clonagem de P√°ginas**: Duplica√ß√£o r√°pida de conte√∫do existente

          ### üöÄ Sistema de Deploy de Projetos:
          - **API OAuth 2.0**: Autentica√ß√£o obrigat√≥ria com renova√ß√£o autom√°tica
          - **Deploy One-Click**: Atualiza√ß√£o ‚Üí compress√£o ‚Üí upload ‚Üí processamento
          - **Valida√ß√£o Robusta**: ZIP seguro com detec√ß√£o de estrutura
          - **Execu√ß√£o Inline**: Banco atualizado sem shell_exec

          ### ü§ñ Sistema de IA:
          - **Integra√ß√£o Gemini API**: Comunica√ß√£o com IA do Google
          - **Sistema Dual de Prompts**: Modos t√©cnicos + necessidades do usu√°rio
          - **Interface Avan√ßada**: CodeMirror com inser√ß√£o posicional
          - **Modelos Atualizados**: Vers√µes recentes do Gemini

          ### üåê Sistema Multil√≠ngue:
          - **Interface Administrativa**: Seletor de idioma no admin-environment
          - **Detec√ß√£o de Browser**: Prioridade para idioma do navegador
          - **Instala√ß√£o Bil√≠ngue**: Sele√ß√£o de idioma durante setup

          ### üîß Como usar:
          1. Use o [Conn2Flow Installer v1.5.0+](https://github.com/otavioserra/conn2flow/releases)
          2. Para instala√ß√£o manual, use `gestor-instalador/index.php`
          3. Selecione o idioma desejado (pt-br/en)
          4. Configure reCAPTCHA no admin-environment
          5. Crie formul√°rios via m√≥dulo de formul√°rios
          6. Configure atualiza√ß√£o remota via API

          ### üìã Requisitos:
          - PHP 8.1+
          - MySQL 5.7+ ou MariaDB 10.2+
          - Extens√µes: zip, curl, mbstring, openssl, pdo_mysql
          - Git (para desenvolvimento de plugins e deploy)
        draft: false
        prerelease: false
        files: |
          gestor.zip
          gestor.zip.sha256
