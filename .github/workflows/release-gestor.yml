name: Release Gestor

on:
  push:
    tags:
      - 'gestor-v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: zip, curl, mbstring, openssl
        
    - name: Install Composer dependencies
      run: |
        cd gestor
        composer install --no-dev --optimize-autoloader --no-interaction
        
    - name: Generate Resources Updates
      run: |
        cd gestor/controladores/agents/arquitetura
        php atualizacao-dados-recursos.php
        echo "Resource updates generated successfully"

    - name: Commit Resources Updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add gestor/db/data/*.json
        git add gestor/db/orphans/*.json
        git add gestor/resources/*
        git add gestor/modulos/*/*.json
        git diff --cached --quiet || git commit -m "Auto-update resources for release ${{ github.ref_name }}"
        
    - name: Remove resource files
      run: |
        # Remove all resource files and directory to make installation lighter
        rm -rf gestor/resources/ && rmdir gestor/resources/ 2>/dev/null || true
        
        # Remove module resource files recursively
        find gestor/modulos -type d -name "resources" -exec rm -rf {} + || true
        
        echo "All resource files removed from release"
        
    - name: Create gestor.zip + checksum
      run: |
        # Remove arquivos desnecess√°rios se existirem
        rm -rf gestor/.git* || true
        rm -rf gestor/vendor/bin/.phpunit* || true
        rm -rf gestor/vendor/composer/tmp-* || true

        # Remover somente .env sens√≠veis da raiz (preservar templates em autenticacoes.exemplo)
        find gestor -maxdepth 1 -type f -name '.env*' -exec rm -f {} + 2>/dev/null || true
        # Remover .env internos reais de autenticacoes, exceto os de templates
        if [ -d gestor/autenticacoes ]; then
          find gestor/autenticacoes -type f -name '.env*' -not -path '*/autenticacoes.exemplo/*' -exec rm -f {} + 2>/dev/null || true
        fi

        # Criar o arquivo ZIP (resource files already removed)
        cd gestor
        zip -r ../gestor.zip . \
          -x "*.git*" \
          -x "vendor/bin/.phpunit*" \
          -x "vendor/composer/tmp-*" \
          -x "node_modules/*" \
          -x "*.DS_Store*" \
          -x "*.log*" \
          -x "tests/*" \
          -x "phpunit.xml*" \
          -x "resources/*" \
          -x "modulos/*/resources/*"
        cd ..
        sha256sum gestor.zip | awk '{print $1}' > gestor.zip.sha256

    - name: Get tag name
      id: tag
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.TAG_NAME }}
        name: "Gestor ${{ steps.tag.outputs.TAG_NAME }}"
        body: |
          ## üöÄ Conn2Flow Gestor Release v2.3.1 (Sistema de IA Integrado Completo)
          
          Esta vers√£o traz a **implementa√ß√£o completa do sistema de IA integrado** ao m√≥dulo admin-paginas, permitindo gera√ß√£o assistida de conte√∫do atrav√©s da API Gemini, al√©m de manter todas as funcionalidades revolucion√°rias do sistema multil√≠ngue e plugins V2.
          
          ### üéØ Novidades Principais desta Vers√£o:
          - ‚úÖ **Sistema de IA Completo Integrado**: Gera√ß√£o assistida de conte√∫do no admin-paginas via API Gemini
          - ‚úÖ **Sistema Dual de Prompts**: Modos t√©cnicos estruturados + prompts de usu√°rio flex√≠veis
          - ‚úÖ **Interface CodeMirror Avan√ßada**: Edi√ß√£o aprimorada com inser√ß√£o de conte√∫do gerado por IA
          - ‚úÖ **Gerenciamento de Sess√£o Inteligente**: Manipula√ß√£o de conte√∫do gerado e inser√ß√£o posicional
          - ‚úÖ **Suporte a M√∫ltiplos Modelos IA**: Configura√ß√£o din√¢mica de servidores e modelos
          - ‚úÖ **Sistema Multil√≠ngue Completo**: Suporte total pt-br/en com interface administrativa
          - ‚úÖ **Seletor de Idioma Administrativo**: Nova aba no admin-environment para mudan√ßa din√¢mica de idioma
          - ‚úÖ **Sistema de Plugins V2**: Arquitetura completamente refatorada com detec√ß√£o din√¢mica
          - ‚úÖ **Templates de Desenvolvimento Automatizados**: Scripts padronizados para cria√ß√£o de plugins
          - ‚úÖ **Rastreio Completo de Origem**: Inje√ß√£o autom√°tica de slug em tabelas com coluna plugin
          - ‚úÖ **Resolu√ß√£o Din√¢mica de Ambiente**: Environment.json din√¢mico em todos os scripts
          - ‚úÖ **Estrutura de Plugins Modernizada**: Nova arquitetura para desenvolvimento Conn2Flow
          - ‚úÖ **Instalador Multil√≠ngue**: Suporte √† sele√ß√£o de idioma durante instala√ß√£o
          - ‚úÖ **P√°gina de Sucesso Bil√≠ngue**: Interface de conclus√£o em portugu√™s e ingl√™s
          
          ### üîß Melhorias T√©cnicas:
          - ‚úÖ **Nova Biblioteca ia.php**: Fun√ß√µes completas para renderiza√ß√£o de prompts e comunica√ß√£o com API Gemini
          - ‚úÖ **Novas Tabelas de Banco**: servidores_ia, modos_ia, prompts_ia para gerenciamento do sistema IA
          - ‚úÖ **Interface JavaScript Avan√ßada**: Controles de IA e gera√ß√£o de conte√∫do com CodeMirror
          - ‚úÖ **Sistema de Sess√£o Robusto**: Gerenciamento de conte√∫do gerado por IA
          - ‚úÖ **Inser√ß√£o Posicional**: Capacidades avan√ßadas de inser√ß√£o de conte√∫do
          - ‚úÖ **Tratamento de Erros Completo**: Valida√ß√£o e tratamento robusto para comunica√ß√£o com API externa
          - ‚úÖ **Migra√ß√£o para IDs Textuais**: Campos de refer√™ncia convertidos para formato textual
          - ‚úÖ **Scripts de Automa√ß√£o Padronizados**: Resolu√ß√£o din√¢mica em todos os scripts
          - ‚úÖ **Arquitetura de Plugins Refatorada**: Sistema V2 com detec√ß√£o autom√°tica
          - ‚úÖ **Timezone Corrigido**: Ajuste para America/Sao_Paulo no Docker
          - ‚úÖ **Compatibilidade Cross-Platform**: Scripts funcionam em qualquer reposit√≥rio
          - ‚úÖ **Limpeza Ampla do Sistema**: Desabilita√ß√£o de ferramentas legadas
          - ‚úÖ **Configura√ß√£o Multil√≠ngue**: Interface intuitiva para mudan√ßa din√¢mica de idioma (pt-br/en)
          - ‚úÖ **Persist√™ncia de Configura√ß√µes**: Salvamento autom√°tico no arquivo .env
          - ‚úÖ **Corre√ß√£o Template .env**: LANGUAGE_DEFAULT agora usa pt-br como padr√£o nas atualiza√ß√µes
          - ‚úÖ **Merge .env Inteligente**: Sistema autom√°tico de corre√ß√£o durante atualiza√ß√µes
          
          ### üì¶ Conte√∫do:
          - Sistema gestor completo com IA integrada e arquitetura h√≠brida multil√≠ngue
          - Biblioteca ia.php funcional para opera√ß√µes de IA
          - Sistema de plugins V2 com templates automatizados
          - Migrations para rastreio completo de dados (coluna plugin) + tabelas IA
          - Sistema de atualiza√ß√£o autom√°tica consolidado (v1.15.0)
          - 264+ recursos organizados por idioma (pt-br base)
          - Seletor de idioma padr√£o no m√≥dulo admin-environment
          - Instalador multil√≠ngue com sele√ß√£o de idioma
          - P√°gina de sucesso bil√≠ngue (pt-br/en)
          - Depend√™ncias do Composer otimizadas
          - Documenta√ß√£o t√©cnica completa incluindo chat-ia.md
          
          ### ü§ñ Sistema de IA:
          - **Integra√ß√£o Gemini API**: Comunica√ß√£o direta com IA do Google para gera√ß√£o de conte√∫do
          - **Sistema Dual de Prompts**: Combina√ß√£o inteligente de modos t√©cnicos e necessidades do usu√°rio
          - **Interface Avan√ßada**: CodeMirror com inser√ß√£o posicional de conte√∫do gerado
          - **Gerenciamento de Sess√£o**: Sistema inteligente para manipula√ß√£o de conte√∫do IA
          - **Suporte Multi-Modelo**: Configura√ß√£o flex√≠vel de servidores e modelos de IA
          - **Valida√ß√£o Robusta**: Tratamento completo de erros e valida√ß√£o de API
          
          ### üåê Sistema Multil√≠ngue:
          - **Interface Administrativa**: Seletor de idioma no painel admin-environment
          - **Persist√™ncia Autom√°tica**: Salvamento em LANGUAGE_DEFAULT no .env
          - **Instala√ß√£o Bil√≠ngue**: Sele√ß√£o de idioma durante setup
          - **P√°gina de Sucesso**: Interface de conclus√£o em portugu√™s e ingl√™s
          - **Corre√ß√£o Autom√°tica**: Template .env corrigido durante atualiza√ß√µes
          
          ### üîß Sistema de Plugins V2:
          - **Detec√ß√£o Din√¢mica**: Sistema autom√°tico de descoberta de Data.json
          - **Templates Automatizados**: Scripts prontos para desenvolvimento de plugins
          - **Rastreio de Origem**: Inje√ß√£o autom√°tica de slug em todas as tabelas
          - **Resolu√ß√£o Din√¢mica**: Environment.json din√¢mico em todos os scripts
          - **Estrutura Moderna**: Arquitetura V2 para desenvolvimento Conn2Flow
          - **Corre√ß√µes Cr√≠ticas**: Sistema robusto com corre√ß√µes importantes
          
          ### üéØ Recursos de Desenvolvimento:
          - Templates completos em `dev-plugins/plugins/templates/`
          - Scripts automatizados de commit, release e workflows
          - Resolu√ß√£o din√¢mica do environment.json
          - Compatibilidade com qualquer reposit√≥rio de plugin
          - Documenta√ß√£o abrangente para desenvolvimento incluindo IA
          
          ### üîß Como usar:
          1. Use o [Conn2Flow Installer v1.5.0+](https://github.com/otavioserra/conn2flow/releases) para instala√ß√£o autom√°tica
          2. Para instala√ß√£o manual, use o instalador web em `gestor-instalador/index.php`
          3. Selecione o idioma desejado durante a instala√ß√£o (pt-br/en)
          4. Utilize os novos templates em `dev-plugins/plugins/templates/` para criar novos plugins
          5. Acesse o admin-environment para alterar o idioma do sistema
          6. Explore o novo sistema de IA integrado no admin-paginas para gera√ß√£o assistida de conte√∫do
          
          ### üìã Requisitos:
          - PHP 8.1+
          - MySQL 5.7+ ou MariaDB 10.2+
          - Extens√µes: zip, curl, mbstring, openssl, pdo_mysql
          - Git (para desenvolvimento de plugins)
          
          ### üåü Padr√µes Aprendidos e Implementados:
          - ‚úÖ **Sistema de IA Revolucion√°rio**: Integra√ß√£o completa com API Gemini e gera√ß√£o assistida
          - ‚úÖ **Sistema Dual de Prompts**: Arquitetura h√≠brida t√©cnica + flex√≠vel
          - ‚úÖ **Interface CodeMirror Avan√ßada**: Edi√ß√£o inteligente com inser√ß√£o posicional
          - ‚úÖ **Sistema Multil√≠ngue**: Implementa√ß√£o completa pt-br/en com seletor administrativo
          - ‚úÖ **Plugins V2**: Arquitetura moderna com detec√ß√£o din√¢mica
          - ‚úÖ **Templates Automatizados**: Scripts padronizados para desenvolvimento
          - ‚úÖ **Rastreio Completo**: Inje√ß√£o autom√°tica de origem em tabelas
          - ‚úÖ **Resolu√ß√£o Din√¢mica**: Environment.json din√¢mico e robusto
          - ‚úÖ **IDs Textuais**: Migra√ß√£o completa para formato textual
          - ‚úÖ **Cross-Platform**: Compatibilidade universal de scripts
          - ‚úÖ **Seletor de Idioma**: Interface administrativa para configura√ß√£o multil√≠ngue
          - ‚úÖ **Template .env Corrigido**: Valor padr√£o pt-br para LANGUAGE_DEFAULT
          - ‚úÖ **Instalador Bil√≠ngue**: Suporte completo √† sele√ß√£o de idioma
          
          ### üéâ Melhorias desta vers√£o:
          - ‚úÖ **Sistema de IA Revolucion√°rio**: Integra√ß√£o completa com gera√ß√£o assistida de conte√∫do
          - ‚úÖ **Interface Inteligente**: CodeMirror avan√ßado com inser√ß√£o posicional de IA
          - ‚úÖ **Sistema Dual Inovador**: Combina√ß√£o perfeita de modos t√©cnicos e prompts flex√≠veis
          - ‚úÖ **Sistema Multil√≠ngue Revolucion√°rio**: Interface completa pt-br/en com seletor administrativo
          - ‚úÖ **Sistema de Plugins Revolucion√°rio**: Arquitetura V2 completa e moderna
          - ‚úÖ **Desenvolvimento Facilitado**: Templates automatizados e documenta√ß√£o
          - ‚úÖ **Rastreabilidade Total**: Sistema completo de origem de dados
          - ‚úÖ **Automa√ß√£o Completa**: Scripts din√¢micos e robustos
          - ‚úÖ **Arquitetura Moderna**: IDs textuais e estrutura refatorada
          - ‚úÖ **Compatibilidade Preservada**: Zero breaking changes para usu√°rios finais
          - ‚úÖ **Administra√ß√£o Multil√≠ngue**: Seletor de idioma intuitivo no painel administrativo
          - ‚úÖ **Instala√ß√£o Inteligente**: Processo bil√≠ngue com sele√ß√£o de idioma
          - ‚úÖ **Corre√ß√µes Cr√≠ticas**: Template .env e sistema de merge corrigidos
          
          ### ‚ö†Ô∏è Breaking Changes (Migration Guide):
          - Novas tabelas de banco para sistema IA: servidores_ia, modos_ia, prompts_ia
          - Campos de refer√™ncia de m√≥dulos migrados para formato textual
          - Scripts de automa√ß√£o padronizados com resolu√ß√£o din√¢mica
          - Arquitetura de plugins modernizada (V2)
          - Timezone ajustado para America/Sao_Paulo
          - Template .env corrigido: LANGUAGE_DEFAULT agora usa pt-br como padr√£o
          - Sistema multil√≠ngue implementado com interface administrativa
          
          ### üîÑ Migration Path:
          1. Use o instalador web para atualiza√ß√£o autom√°tica
          2. Ou execute: `php controladores/atualizacoes/atualizacoes-sistema.php --env-dir=seu-dominio`
          3. Execute migra√ß√µes de banco para adicionar tabelas IA: `php controladores/atualizacoes/atualizacoes-banco-de-dados.php --env-dir=seu-dominio`
          4. Atualize scripts de plugins para usar resolu√ß√£o din√¢mica
          5. Utilize os novos templates para desenvolvimento
          6. Aproveite a arquitetura V2 de plugins
          7. Template .env ser√° automaticamente corrigido com LANGUAGE_DEFAULT=pt-br
          8. Configure o idioma do sistema via admin-environment
          9. Explore o novo sistema de IA no admin-paginas
        draft: false
        prerelease: false
        files: |
          gestor.zip
          gestor.zip.sha256
