name: Release Gestor

on:
  push:
    tags:
      - 'gestor-v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: zip, curl, mbstring, openssl
        
    - name: Install Composer dependencies
      run: |
        cd gestor
        composer install --no-dev --optimize-autoloader --no-interaction
        
    - name: Generate Resources Updates
      run: |
        cd gestor/controladores/agents/arquitetura
        php atualizacao-dados-recursos.php
        echo "Resource updates generated successfully"

    - name: Commit Resources Updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add gestor/db/data/*.json
        git add gestor/db/orphans/*.json
        git add gestor/resources/*
        git add gestor/modulos/*/*.json
        git diff --cached --quiet || git commit -m "Auto-update resources for release ${{ github.ref_name }}"
        
    - name: Remove resource files
      run: |
        # Remove all resource files and directory to make installation lighter
        rm -rf gestor/resources/ && rmdir gestor/resources/ 2>/dev/null || true
        
        # Remove module resource files recursively
        find gestor/modulos -type d -name "resources" -exec rm -rf {} + || true
        
        echo "All resource files removed from release"
        
    - name: Create gestor.zip + checksum
      run: |
        # Remove arquivos desnecess√°rios se existirem
        rm -rf gestor/.git* || true
        rm -rf gestor/vendor/bin/.phpunit* || true
        rm -rf gestor/vendor/composer/tmp-* || true

        # Remover somente .env sens√≠veis da raiz (preservar templates em autenticacoes.exemplo)
        find gestor -maxdepth 1 -type f -name '.env*' -exec rm -f {} + 2>/dev/null || true
        # Remover .env internos reais de autenticacoes, exceto os de templates
        if [ -d gestor/autenticacoes ]; then
          find gestor/autenticacoes -type f -name '.env*' -not -path '*/autenticacoes.exemplo/*' -exec rm -f {} + 2>/dev/null || true
        fi

        # Criar o arquivo ZIP (resource files already removed)
        cd gestor
        zip -r ../gestor.zip . \
          -x "*.git*" \
          -x "vendor/bin/.phpunit*" \
          -x "vendor/composer/tmp-*" \
          -x "node_modules/*" \
          -x "*.DS_Store*" \
          -x "*.log*" \
          -x "tests/*" \
          -x "phpunit.xml*" \
          -x "resources/*" \
          -x "modulos/*/resources/*"
        cd ..
        sha256sum gestor.zip | awk '{print $1}' > gestor.zip.sha256

    - name: Get tag name
      id: tag
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.TAG_NAME }}
        name: "Gestor ${{ steps.tag.outputs.TAG_NAME }}"
        body: |
          ## üöÄ Conn2Flow Gestor Release v2.6.3 (Menu Administrativo Responsivo + Dashboard Otimizado para Tablets)

          Esta vers√£o traz o **redesign completo do menu administrativo** com comportamento responsivo unificado para mobile e tablets, menu redimension√°vel, persist√™ncia de estado, e dashboard otimizado para tablets, al√©m de manter todas as funcionalidades do m√≥dulo Publisher, sistema de IA integrado, deploy OAuth e arquitetura multil√≠ngue.

          ### üéØ Novidades Principais desta Vers√£o:
          - ‚úÖ **Menu Administrativo Responsivo**: Redesign completo com bot√£o toggle flutuante, largura redimension√°vel e persist√™ncia em localStorage
          - ‚úÖ **Sidebar Overlay para Mobile/Tablet**: Comportamento unificado de sidebar overlay para dispositivos at√© 1024px de largura
          - ‚úÖ **Menu Redimension√°vel**: Handle de arraste para ajustar largura do menu (200-450px) com persist√™ncia em tempo real
          - ‚úÖ **Atalho de Teclado**: Ctrl/Cmd+B para alternar visibilidade do menu
          - ‚úÖ **Dashboard Otimizado para Tablet**: Layout de cards em 2 colunas em tablets para melhor usabilidade
          - ‚úÖ **Transi√ß√µes CSS Suaves**: Anima√ß√µes fluidas com inicializa√ß√£o sem anima√ß√£o para evitar flashes
          - ‚úÖ **Overlay Mobile com Backdrop**: Fundo escuro quando menu mobile/tablet est√° aberto
          - ‚úÖ **Persist√™ncia de Estado do Menu**: Largura e estado fechado salvos em localStorage
          - ‚úÖ **Duplo Clique para Reset**: Duplo clique no handle de resize reseta largura padr√£o (250px)
          - ‚úÖ **M√≥dulo Publisher Completo**: Novo m√≥dulo de publica√ß√£o de conte√∫do (mantido da v2.6.0)
          - ‚úÖ **Editor Quill WYSIWYG**: Integra√ß√£o profissional do editor Quill (mantido da v2.6.0)
          - ‚úÖ **Sistema de Campos Din√¢micos**: Campos configur√°veis para templates de publisher (mantido da v2.6.0)
          - ‚úÖ **Funcionalidade de Clonagem**: Clone r√°pido de p√°ginas admin, templates admin e p√°ginas do publisher (mantido da v2.6.0)
          - ‚úÖ **Image Picker no Editor HTML**: Seletor visual de imagens integrado ao editor (mantido da v2.6.0)
          - ‚úÖ **Sistema Completo de Deploy via OAuth**: Deploy automatizado com OAuth 2.0 (mantido da v2.4.0)
          - ‚úÖ **Sistema de IA Integrado**: Gera√ß√£o de conte√∫do via API Gemini (mantido da v2.4.0)
          - ‚úÖ **Sistema Multil√≠ngue Completo**: Suporte pt-br/en (mantido da v2.4.0)
          - ‚úÖ **Sistema de Plugins V2**: Arquitetura refatorada (mantido da v2.4.0)

          ### üîß Melhorias T√©cnicas:
          - ‚úÖ **Breakpoint Mobile/Tablet**: Alterado de 770px para 1024px para incluir tablets no comportamento de sidebar overlay
          - ‚úÖ **Nova Estrutura de Classes CSS**: `menu-closed`, `menu-mobile-open`, `menu-no-transition` para controle de estado
          - ‚úÖ **Bot√£o Toggle Flutuante**: Aparece quando menu est√° fechado para f√°cil acesso
          - ‚úÖ **Handle de Redimensionamento**: Suporte a mouse e touch para ajuste de largura
          - ‚úÖ **Media Queries Reorganizadas**: mobile/tablet (‚â§1024px) e desktop (‚â•1025px)
          - ‚úÖ **Dashboard Cards Responsivos**: Grid adaptativo 1/2/4 colunas conforme tamanho da tela
          - ‚úÖ **Inicializa√ß√£o Sem Anima√ß√£o**: Classe `menu-no-transition` evita flashes visuais no carregamento

          ### üì¶ Conte√∫do:
          - Sistema gestor completo com menu administrativo responsivo
          - Dashboard otimizado para tablets com layout de 2 colunas
          - M√≥dulo Publisher com editor Quill integrado
          - Funcionalidade de clonagem para p√°ginas e templates
          - Image picker integrado ao editor HTML visual
          - Biblioteca `html-editor.php` com componentes reutiliz√°veis
          - Sistema de sele√ß√£o de templates com interface de cards
          - Scripts de deploy automatizado
          - Biblioteca ia.php para opera√ß√µes de IA e OAuth
          - Sistema de plugins V2 com templates automatizados
          - Migrations para m√≥dulo publisher e campos din√¢micos
          - Sistema de atualiza√ß√£o autom√°tica consolidado
          - Recursos organizados por idioma (pt-br base)
          - Instalador multil√≠ngue com sele√ß√£o de idioma
          - Depend√™ncias do Composer otimizadas
          - Documenta√ß√£o t√©cnica completa

          ### üì± Menu Administrativo Responsivo:
          - **Bot√£o Toggle Flutuante**: Aparece quando menu est√° fechado
          - **Menu Redimension√°vel**: Arraste o handle para ajustar largura (200-450px)
          - **Sidebar Overlay em Mobile/Tablet**: Comportamento unificado at√© 1024px
          - **Atalho de Teclado**: Ctrl/Cmd+B para toggle do menu
          - **Persist√™ncia de Estado**: Largura e estado salvos em localStorage
          - **Duplo Clique para Reset**: Restaura largura padr√£o de 250px
          - **Transi√ß√µes Suaves**: Anima√ß√µes fluidas sem flashes na inicializa√ß√£o

          ### üìä Dashboard Otimizado:
          - **Layout Responsivo**: Grid adaptativo conforme tamanho da tela
          - **1 Coluna**: Dispositivos at√© 767px (mobile)
          - **2 Colunas**: Dispositivos de 768px a 1024px (tablet)
          - **4 Colunas**: Dispositivos acima de 1025px (desktop)

          ### üì∞ M√≥dulo Publisher:
          - **CRUD Completo**: Gerenciamento de publishers (defini√ß√µes) e p√°ginas
          - **Editor Quill WYSIWYG**: Edi√ß√£o rica com formata√ß√£o avan√ßada
          - **Sistema de Campos Din√¢micos**: Campos configur√°veis por template
          - **Templates Abstratos**: Templates prontos (ex: not√≠cias) gerados por IA
          - **Clonagem de P√°ginas**: Duplica√ß√£o r√°pida de conte√∫do existente
          - **Integra√ß√£o com Sistema IA**: Gera√ß√£o assistida de conte√∫do

          ### üöÄ Sistema de Deploy de Projetos:
          - **API OAuth 2.0**: Autentica√ß√£o obrigat√≥ria com renova√ß√£o autom√°tica
          - **Deploy One-Click**: Atualiza√ß√£o ‚Üí compress√£o ‚Üí upload ‚Üí processamento
          - **Valida√ß√£o Robusta**: ZIP seguro com detec√ß√£o de estrutura
          - **Execu√ß√£o Inline**: Banco atualizado sem shell_exec

          ### ü§ñ Sistema de IA:
          - **Integra√ß√£o Gemini API**: Comunica√ß√£o com IA do Google
          - **Sistema Dual de Prompts**: Modos t√©cnicos + necessidades do usu√°rio
          - **Interface Avan√ßada**: CodeMirror com inser√ß√£o posicional
          - **Modelos Atualizados**: Vers√µes recentes do Gemini

          ### üåê Sistema Multil√≠ngue:
          - **Interface Administrativa**: Seletor de idioma no admin-environment
          - **Detec√ß√£o de Browser**: Prioridade para idioma do navegador
          - **Instala√ß√£o Bil√≠ngue**: Sele√ß√£o de idioma durante setup

          ### üîß Como usar:
          1. Use o [Conn2Flow Installer v1.5.0+](https://github.com/otavioserra/conn2flow/releases)
          2. Para instala√ß√£o manual, use `gestor-instalador/index.php`
          3. Selecione o idioma desejado (pt-br/en)
          4. Explore o menu responsivo com suporte a tablets
          5. Ajuste a largura do menu arrastando o handle
          6. Use Ctrl/Cmd+B para toggle r√°pido do menu
          7. Explore o dashboard otimizado para tablets

          ### üìã Requisitos:
          - PHP 8.1+
          - MySQL 5.7+ ou MariaDB 10.2+
          - Extens√µes: zip, curl, mbstring, openssl, pdo_mysql
          - Git (para desenvolvimento de plugins e deploy)
        draft: false
        prerelease: false
        files: |
          gestor.zip
          gestor.zip.sha256
