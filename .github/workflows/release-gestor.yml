name: Release Gestor

on:
  push:
    tags:
      - 'gestor-v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: zip, curl, mbstring, openssl
        
    - name: Install Composer dependencies
      run: |
        cd gestor
        composer install --no-dev --optimize-autoloader --no-interaction
        
    - name: Generate Resources Updates
      run: |
        cd gestor/controladores/agents/arquitetura
        php atualizacao-dados-recursos.php
        echo "Resource updates generated successfully"

    - name: Commit Resources Updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add gestor/db/data/*.json
        git add gestor/db/orphans/*.json
        git add gestor/resources/*
        git add gestor/modulos/*/*.json
        git diff --cached --quiet || git commit -m "Auto-update resources for release ${{ github.ref_name }}"
        
    - name: Remove resource files
      run: |
        # Remove all resource files and directory to make installation lighter
        rm -rf gestor/resources/ && rmdir gestor/resources/ 2>/dev/null || true
        
        # Remove module resource files recursively
        find gestor/modulos -type d -name "resources" -exec rm -rf {} + || true
        
        echo "All resource files removed from release"
        
    - name: Create gestor.zip + checksum
      run: |
        # Remove arquivos desnecessários se existirem
        rm -rf gestor/.git* || true
        rm -rf gestor/vendor/bin/.phpunit* || true
        rm -rf gestor/vendor/composer/tmp-* || true

        # Remover somente .env sensíveis da raiz (preservar templates em autenticacoes.exemplo)
        find gestor -maxdepth 1 -type f -name '.env*' -exec rm -f {} + 2>/dev/null || true
        # Remover .env internos reais de autenticacoes, exceto os de templates
        if [ -d gestor/autenticacoes ]; then
          find gestor/autenticacoes -type f -name '.env*' -not -path '*/autenticacoes.exemplo/*' -exec rm -f {} + 2>/dev/null || true
        fi

        # Criar o arquivo ZIP (resource files already removed)
        cd gestor
        zip -r ../gestor.zip . \
          -x "*.git*" \
          -x "vendor/bin/.phpunit*" \
          -x "vendor/composer/tmp-*" \
          -x "node_modules/*" \
          -x "*.DS_Store*" \
          -x "*.log*" \
          -x "tests/*" \
          -x "phpunit.xml*" \
          -x "resources/*" \
          -x "modulos/*/resources/*"
        cd ..
        sha256sum gestor.zip | awk '{print $1}' > gestor.zip.sha256

    - name: Get tag name
      id: tag
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.TAG_NAME }}
        name: "Gestor ${{ steps.tag.outputs.TAG_NAME }}"
        body: |
          ## 🚀 Conn2Flow Gestor Release v2.0.X (Sistema de Preview + Framework CSS)
          
          Esta release traz **grandes melhorias nos módulos administrativos** com sistema de preview TailwindCSS e suporte multi-framework CSS.
          
          ### 🎯 Novidades Principais desta Versão:
          - ✅ **Sistema de Preview TailwindCSS**: Pré-visualização em tempo real para layouts, páginas e componentes
          - ✅ **Suporte Multi-Framework CSS**: Escolha entre TailwindCSS e FomanticUI por recurso
          - ✅ **Módulos Admin Modernizados**: admin-layouts, admin-paginas e admin-componentes com interface melhorada
          - ✅ **Sistema de Modal Avançado**: Modals responsivos com CodeMirror integrado
          - ✅ **Ordem de Dependências Otimizada**: Resolução de problemas de inicialização DOM
          - ✅ **Validação de Framework CSS**: Campo obrigatório para recursos visuais
          
          ### 🔧 Melhorias Técnicas:
          - ✅ **gestor_componente() Corrigido**: Uso adequado sem parâmetro 'variaveis'
          - ✅ **modelo_var_troca() Individual**: Substituições precisas de placeholders
          - ✅ **Endpoints de Preview**: Sistema robusto para geração de HTML em tempo real
          - ✅ **JavaScript Otimizado**: Funções de callback para botões personalizados
          - ✅ **Padrões Documentados**: Template atualizado para novos módulos
          
          ### 📦 Conteúdo:
          - Sistema gestor completo com arquitetura híbrida multilíngue
          - Migrations para suporte framework_css (campo VARCHAR(50))
          - Sistema de atualização automática consolidado (v1.15.0)
          - 264 recursos organizados por idioma (pt-br base)
          - Dependências do Composer otimizadas
          - Documentação técnica completa
          
          ### 🔧 Módulos Administrativos Atualizados:
          - **admin-layouts**: Preview TailwindCSS + validação framework_css
          - **admin-componentes**: Sistema modal otimizado + CodeMirror
          - **admin-paginas**: Referência de padrões corretos implementados
          
          ### 🎯 Sistema de Preview:
          - Modal de pré-visualização responsivo
          - Suporte TailwindCSS via CDN
          - Fallback FomanticUI automático
          - Iframe isolado para renderização
          - Callback JavaScript personalizado
          
          ### 🔧 Como usar:
          1. Use o [Conn2Flow Installer v1.4.0+](https://github.com/otavioserra/conn2flow/releases) para instalação automática
          2. Ou extraia manualmente e execute: `php phinx.php migrate && php phinx.php seed:run`
          3. Aproveite os novos recursos de preview nos módulos administrativos
          
          ### 📋 Requisitos:
          - PHP 8.1+
          - MySQL 5.7+ ou MariaDB 10.2+
          - Extensões: zip, curl, mbstring, openssl, pdo_mysql
          - Acesso à internet (para TailwindCSS CDN no preview)
          
          ### 🌟 Padrões Aprendidos e Implementados:
          - ✅ **Ordem Crítica**: Modal ANTES do CodeMirror nas dependências
          - ✅ **Componentes**: gestor_componente() retorna HTML que precisa de modelo_var_troca()
          - ✅ **Frameworks**: Campo framework_css obrigatório para recursos visuais
          - ✅ **Preview**: Endpoints PHP + JavaScript para pré-visualização
          - ✅ **Validação**: Formulários com validação de framework CSS
          
          ### 🎉 Melhorias desta versão:
          - ✅ **Interface moderna**: Sistema de preview intuitivo e responsivo
          - ✅ **Flexibilidade CSS**: Escolha livre entre frameworks por recurso
          - ✅ **Desenvolvimento facilitado**: Padrões claros para novos módulos
          - ✅ **Administração melhorada**: Interface mais rica e funcional
          - ✅ **Documentação completa**: Guias técnicos para desenvolvedores
          - ✅ **Compatibilidade preservada**: Zero breaking changes para usuários finais
        draft: false
        prerelease: false
        files: |
          gestor.zip
          gestor.zip.sha256
