name: Release Gestor Instalador

on:
  push:
    tags:
      - 'instalador-v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create instalador.zip
      run: |
        # Criar o arquivo ZIP com apenas o gestor-instalador
        cd gestor-instalador
        zip -r ../instalador.zip . \
          -x "*.git*" \
          -x "*.DS_Store*" \
          -x "*.log*" \
          -x "temp/*" \
          -x ".env.debug"

    - name: Get tag name
      id: tag
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.TAG_NAME }}
        name: "Instalador ${{ steps.tag.outputs.TAG_NAME }}"
        body: |
          ## ğŸ› ï¸ Conn2Flow Instalador Release v1.4.0 (Suporte Framework CSS + Melhorias)
          
          Instalador automÃ¡tico do sistema Conn2Flow com **suporte aos novos recursos v1.16.0** incluindo sistema de preview e framework CSS.
          
          ### âœ¨ Novidades desta VersÃ£o:
          - âœ… **Suporte Framework CSS**: InstalaÃ§Ã£o preparada para TailwindCSS + FomanticUI
          - âœ… **Migrations Atualizadas**: Campo framework_css automaticamente configurado
          - âœ… **ValidaÃ§Ã£o Aprimorada**: VerificaÃ§Ã£o de recursos visuais pÃ³s-instalaÃ§Ã£o
          - âœ… **Preview System Ready**: InstalaÃ§Ã£o preparada para sistema de preview
          - âœ… **Charset UTF-8 Robusto**: Compatibilidade total com caracteres especiais
          - âœ… **Logs Detalhados**: Rastreamento completo do processo de instalaÃ§Ã£o
          
          ### ğŸ”§ Melhorias TÃ©cnicas:
          - âœ… **getPdo() Unificado**: MÃ©todo Ãºnico para todas conexÃµes de banco
          - âœ… **DetecÃ§Ã£o de URL Robusta**: Funcionamento em subpasta ou raiz
          - âœ… **UsuÃ¡rio Admin Otimizado**: CriaÃ§Ã£o robusta com nomes dinÃ¢micos
          - âœ… **Auto-login Aprimorado**: ConfiguraÃ§Ã£o automÃ¡tica pÃ³s-instalaÃ§Ã£o
          - âœ… **Limpeza Inteligente**: RemoÃ§Ã£o automÃ¡tica apÃ³s sucesso
          
          ### âœ¨ Funcionalidades:
          - InstalaÃ§Ã£o totalmente automatizada
          - Interface web amigÃ¡vel e multilÃ­ngue
          - Sistema hÃ­brido de migraÃ§Ã£o (Phinx + SQL fallback)
          - CompatÃ­vel com hospedagem compartilhada (cPanel)
          - Suporte multi-idioma (PT-BR, EN)
          - PreparaÃ§Ã£o automÃ¡tica para preview TailwindCSS
          
          ### ğŸ”§ Como usar:
          1. Baixe o `instalador.zip`
          2. Extraia em seu servidor web
          3. Acesse via navegador: `http://seudominio.com/gestor-instalador/`
          4. Siga o assistente de instalaÃ§Ã£o
          5. Aproveite os novos recursos de preview!
          
          ### ğŸ“‹ Requisitos:
          - PHP 8.1+
          - MySQL 5.7+ ou MariaDB 10.2+
          - ExtensÃµes: zip, curl, mbstring, openssl, pdo_mysql
          - Acesso Ã  internet (para download do gestor + TailwindCSS CDN)
          
          ### ğŸ¯ Funcionalidades do Instalador:
          - âœ… ValidaÃ§Ã£o de requisitos do sistema
          - âœ… Download automÃ¡tico do gestor v1.16.0+
          - âœ… ConfiguraÃ§Ã£o automÃ¡tica do banco de dados
          - âœ… Migrations framework_css aplicadas automaticamente
          - âœ… GeraÃ§Ã£o de chaves de seguranÃ§a
          - âœ… ConfiguraÃ§Ã£o de domÃ­nio e usuÃ¡rio admin
          - âœ… PreparaÃ§Ã£o sistema de preview
          - âœ… Cleanup automÃ¡tico pÃ³s-instalaÃ§Ã£o
          
          ### ğŸŒ Ambientes Suportados:
          - Hosting compartilhado (cPanel/Plesk)
          - VPS/Servidor dedicado
          - Desenvolvimento local (XAMPP/WAMP/MAMP)
          - Containers Docker
          
          ### ğŸš€ Compatibilidade com Gestor v1.16.0:
          - âœ… **MÃ³dulos Admin**: InstalaÃ§Ã£o preparada para admin-layouts, admin-componentes
          - âœ… **Framework CSS**: Campo framework_css configurado automaticamente
          - âœ… **Sistema Preview**: Estrutura preparada para modals e CodeMirror
          - âœ… **Endpoints Preview**: ConfiguraÃ§Ã£o automÃ¡tica de controladores
          - âœ… **DependÃªncias Assets**: Ordem correta de inclusÃ£o garantida
          
          ### ğŸ“Š Melhorias de Robustez:
          - âœ… **Charset Universal**: UTF-8/utf8mb4 em todas operaÃ§Ãµes
          - âœ… **Error Handling**: Tratamento robusto de erros SQL
          - âœ… **Path Detection**: DetecÃ§Ã£o automÃ¡tica de caminhos e URLs
          - âœ… **Permission Fixes**: Ajustes automÃ¡ticos de permissÃµes
          - âœ… **Cross-Platform**: Funcionamento Windows/Linux/macOS
        draft: false
        prerelease: false
        files: instalador.zip
