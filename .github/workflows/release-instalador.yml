name: Release Gestor Instalador

on:
  push:
    tags:
      - 'instalador-v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create instalador.zip
      run: |
        # Criar o arquivo ZIP com apenas o gestor-instalador
        cd gestor-instalador
        zip -r ../instalador.zip . \
          -x "*.git*" \
          -x "*.DS_Store*" \
          -x "*.log*" \
          -x "temp/*" \
          -x ".env.debug"

    - name: Get tag name
      id: tag
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.TAG_NAME }}
        name: "Instalador ${{ steps.tag.outputs.TAG_NAME }}"
        make_latest: true
        fail_on_unmatched_files: true
        body: |
          ## ğŸ› ï¸ Conn2Flow Instalador Release v1.5.1 (Sistema MultilÃ­ngue Completo + Gestor v2.2.x)
          
          Instalador automÃ¡tico do sistema Conn2Flow com **suporte aos novos recursos v2.2.x** incluindo sistema multilÃ­ngue completo, seletor de idioma administrativo e arquitetura de plugins V2.
          
          ### âœ¨ Novidades desta VersÃ£o:
          - âœ… **Sistema MultilÃ­ngue Completo**: Suporte total pt-br/en com interface administrativa
          - âœ… **Seletor de Idioma Administrativo**: Nova aba no admin-environment para mudanÃ§a dinÃ¢mica de idioma
          - âœ… **Sistema de Plugins V2**: Arquitetura completamente refatorada com detecÃ§Ã£o dinÃ¢mica
          - âœ… **Templates de Desenvolvimento Automatizados**: Scripts padronizados para criaÃ§Ã£o de plugins
          - âœ… **Rastreio Completo de Origem**: InjeÃ§Ã£o automÃ¡tica de slug em tabelas com coluna plugin
          - âœ… **ResoluÃ§Ã£o DinÃ¢mica de Ambiente**: Environment.json dinÃ¢mico em todos os scripts
          - âœ… **Estrutura de Plugins Modernizada**: Nova arquitetura para desenvolvimento Conn2Flow
          - âœ… **Instalador MultilÃ­ngue**: Suporte Ã  seleÃ§Ã£o de idioma durante instalaÃ§Ã£o
          - âœ… **PÃ¡gina de Sucesso BilÃ­ngue**: Interface de conclusÃ£o em portuguÃªs e inglÃªs
          
          ### ğŸ”§ Melhorias TÃ©cnicas:
          - âœ… **getPdo() Unificado**: MÃ©todo Ãºnico para todas conexÃµes de banco
          - âœ… **DetecÃ§Ã£o de URL Robusta**: Funcionamento em subpasta ou raiz
          - âœ… **UsuÃ¡rio Admin Otimizado**: CriaÃ§Ã£o robusta com nomes dinÃ¢micos
          - âœ… **Auto-login Aprimorado**: ConfiguraÃ§Ã£o automÃ¡tica pÃ³s-instalaÃ§Ã£o
          - âœ… **Limpeza Inteligente**: RemoÃ§Ã£o automÃ¡tica apÃ³s sucesso
          - âœ… **ConfiguraÃ§Ã£o MultilÃ­ngue**: Interface intuitiva para mudanÃ§a dinÃ¢mica de idioma (pt-br/en)
          - âœ… **PersistÃªncia de ConfiguraÃ§Ãµes**: Salvamento automÃ¡tico no arquivo .env
          - âœ… **CorreÃ§Ã£o Template .env**: LANGUAGE_DEFAULT agora usa pt-br como padrÃ£o nas atualizaÃ§Ãµes
          - âœ… **Merge .env Inteligente**: Sistema automÃ¡tico de correÃ§Ã£o durante atualizaÃ§Ãµes
          
          ### âœ¨ Funcionalidades:
          - InstalaÃ§Ã£o totalmente automatizada
          - Interface web amigÃ¡vel e multilÃ­ngue
          - Sistema hÃ­brido de migraÃ§Ã£o (Phinx + SQL fallback)
          - CompatÃ­vel com hospedagem compartilhada (cPanel)
          - Suporte multi-idioma (PT-BR, EN)
          - PreparaÃ§Ã£o automÃ¡tica para preview TailwindCSS
          
          ### ğŸ”§ Como usar:
          1. Baixe o `instalador.zip`
          2. Extraia em seu servidor web
          3. Acesse via navegador: `http://seudominio.com/gestor-instalador/`
          4. Siga o assistente de instalaÃ§Ã£o
          5. Aproveite os novos recursos de preview!
          
          ### ğŸ“‹ Requisitos:
          - PHP 8.1+
          - MySQL 5.7+ ou MariaDB 10.2+
          - ExtensÃµes: zip, curl, mbstring, openssl, pdo_mysql
          - Acesso Ã  internet (para download do gestor + TailwindCSS CDN)
          
          ### ğŸ¯ Funcionalidades do Instalador:
          - âœ… ValidaÃ§Ã£o de requisitos do sistema
          - âœ… Download automÃ¡tico do gestor v2.2.x+
          - âœ… ConfiguraÃ§Ã£o automÃ¡tica do banco de dados
          - âœ… Migrations framework_css aplicadas automaticamente
          - âœ… GeraÃ§Ã£o de chaves de seguranÃ§a
          - âœ… ConfiguraÃ§Ã£o de domÃ­nio e usuÃ¡rio admin
          - âœ… PreparaÃ§Ã£o sistema de preview
          - âœ… Cleanup automÃ¡tico pÃ³s-instalaÃ§Ã£o
          
          ### ğŸŒ Ambientes Suportados:
          - Hosting compartilhado (cPanel/Plesk)
          - VPS/Servidor dedicado
          - Desenvolvimento local (XAMPP/WAMP/MAMP)
          - Containers Docker
          
          ### ğŸš€ Compatibilidade com Gestor v2.2.x:
          - âœ… **Sistema MultilÃ­ngue**: Interface completa pt-br/en com seletor administrativo
          - âœ… **Plugins V2**: Arquitetura moderna com detecÃ§Ã£o dinÃ¢mica
          - âœ… **Templates Automatizados**: Scripts padronizados para desenvolvimento
          - âœ… **Rastreio de Origem**: InjeÃ§Ã£o automÃ¡tica de slug em tabelas
          - âœ… **ResoluÃ§Ã£o DinÃ¢mica**: Environment.json dinÃ¢mico e robusto
          - âœ… **IDs Textuais**: MigraÃ§Ã£o completa para formato textual
          - âœ… **Cross-Platform**: Compatibilidade universal de scripts
          - âœ… **Seletor de Idioma**: Interface administrativa para configuraÃ§Ã£o multilÃ­ngue
          - âœ… **Template .env Corrigido**: Valor padrÃ£o pt-br para LANGUAGE_DEFAULT
          - âœ… **Instalador BilÃ­ngue**: Suporte completo Ã  seleÃ§Ã£o de idioma
          
          ### ğŸ“Š Melhorias de Robustez:
          - âœ… **Charset Universal**: UTF-8/utf8mb4 em todas operaÃ§Ãµes
          - âœ… **Error Handling**: Tratamento robusto de erros SQL
          - âœ… **Path Detection**: DetecÃ§Ã£o automÃ¡tica de caminhos e URLs
          - âœ… **Permission Fixes**: Ajustes automÃ¡ticos de permissÃµes
          - âœ… **Cross-Platform**: Funcionamento Windows/Linux/macOS
        draft: false
        prerelease: false
        files: instalador.zip
