name: Release Gestor Instalador

on:
  push:
    tags:
      - 'instalador-v*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create instalador.zip
      run: |
        # Criar o arquivo ZIP com apenas o gestor-instalador
        cd gestor-instalador
        zip -r ../instalador.zip . \
          -x "*.git*" \
          -x "*.DS_Store*" \
          -x "*.log*" \
          -x "temp/*"
          
    - name: Get tag name
      id: tag
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.TAG_NAME }}
        release_name: "Instalador ${{ steps.tag.outputs.TAG_NAME }}"
        body: |
          ## üõ†Ô∏è Conn2Flow Instalador Release
          
          Instalador autom√°tico do sistema Conn2Flow.
          
          ### ‚ú® Funcionalidades:
          - Instala√ß√£o totalmente automatizada
          - Interface web amig√°vel
          - Sistema h√≠brido de migra√ß√£o (Phinx + SQL fallback)
          - Compat√≠vel com hospedagem compartilhada (cPanel)
          - Suporte multi-idioma (PT-BR, EN)
          
          ### üîß Como usar:
          1. Baixe o `instalador.zip`
          2. Extraia em seu servidor web
          3. Acesse via navegador: `http://seudominio.com/gestor-instalador/`
          4. Siga o assistente de instala√ß√£o
          
          ### üìã Requisitos:
          - PHP 8.1+
          - MySQL 5.7+ ou MariaDB 10.2+
          - Extens√µes: zip, curl, mbstring, openssl, pdo_mysql
          - Acesso √† internet (para download do gestor)
          
          ### üéØ Funcionalidades do Instalador:
          - ‚úÖ Valida√ß√£o de requisitos do sistema
          - ‚úÖ Download autom√°tico do gestor mais recente
          - ‚úÖ Configura√ß√£o autom√°tica do banco de dados
          - ‚úÖ Gera√ß√£o de chaves de seguran√ßa
          - ‚úÖ Configura√ß√£o de dom√≠nio e usu√°rio admin
          - ‚úÖ Cleanup autom√°tico p√≥s-instala√ß√£o
          
          ### üåê Ambientes Suportados:
          - Hosting compartilhado (cPanel/Plesk)
          - VPS/Servidor dedicado
          - Desenvolvimento local (XAMPP/WAMP/MAMP)
        draft: false
        prerelease: false
        
    - name: Upload instalador.zip
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./instalador.zip
        asset_name: instalador.zip
        asset_content_type: application/zip
