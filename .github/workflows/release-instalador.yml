name: Release Gestor Instalador

on:
  push:
    tags:
      - 'instalador-v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create instalador.zip
      run: |
        # Criar o arquivo ZIP com apenas o gestor-instalador
        cd gestor-instalador
        zip -r ../instalador.zip . \
          -x "*.git*" \
          -x "*.DS_Store*" \
          -x "*.log*" \
          -x "temp/*" \
          -x ".env.debug"

    - name: Get tag name
      id: tag
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.TAG_NAME }}
        name: "Instalador ${{ steps.tag.outputs.TAG_NAME }}"
        body: |
          ## 🛠️ Conn2Flow Instalador Release v1.5.1 (Sistema Multilíngue Completo + Gestor v2.2.x)
          
          Instalador automático do sistema Conn2Flow com **suporte aos novos recursos v2.2.x** incluindo sistema multilíngue completo, seletor de idioma administrativo e arquitetura de plugins V2.
          
          ### ✨ Novidades desta Versão:
          - ✅ **Sistema Multilíngue Completo**: Suporte total pt-br/en com interface administrativa
          - ✅ **Seletor de Idioma Administrativo**: Nova aba no admin-environment para mudança dinâmica de idioma
          - ✅ **Sistema de Plugins V2**: Arquitetura completamente refatorada com detecção dinâmica
          - ✅ **Templates de Desenvolvimento Automatizados**: Scripts padronizados para criação de plugins
          - ✅ **Rastreio Completo de Origem**: Injeção automática de slug em tabelas com coluna plugin
          - ✅ **Resolução Dinâmica de Ambiente**: Environment.json dinâmico em todos os scripts
          - ✅ **Estrutura de Plugins Modernizada**: Nova arquitetura para desenvolvimento Conn2Flow
          - ✅ **Instalador Multilíngue**: Suporte à seleção de idioma durante instalação
          - ✅ **Página de Sucesso Bilíngue**: Interface de conclusão em português e inglês
          
          ### 🔧 Melhorias Técnicas:
          - ✅ **getPdo() Unificado**: Método único para todas conexões de banco
          - ✅ **Detecção de URL Robusta**: Funcionamento em subpasta ou raiz
          - ✅ **Usuário Admin Otimizado**: Criação robusta com nomes dinâmicos
          - ✅ **Auto-login Aprimorado**: Configuração automática pós-instalação
          - ✅ **Limpeza Inteligente**: Remoção automática após sucesso
          - ✅ **Configuração Multilíngue**: Interface intuitiva para mudança dinâmica de idioma (pt-br/en)
          - ✅ **Persistência de Configurações**: Salvamento automático no arquivo .env
          - ✅ **Correção Template .env**: LANGUAGE_DEFAULT agora usa pt-br como padrão nas atualizações
          - ✅ **Merge .env Inteligente**: Sistema automático de correção durante atualizações
          
          ### ✨ Funcionalidades:
          - Instalação totalmente automatizada
          - Interface web amigável e multilíngue
          - Sistema híbrido de migração (Phinx + SQL fallback)
          - Compatível com hospedagem compartilhada (cPanel)
          - Suporte multi-idioma (PT-BR, EN)
          - Preparação automática para preview TailwindCSS
          
          ### 🔧 Como usar:
          1. Baixe o `instalador.zip`
          2. Extraia em seu servidor web
          3. Acesse via navegador: `http://seudominio.com/gestor-instalador/`
          4. Siga o assistente de instalação
          5. Aproveite os novos recursos de preview!
          
          ### 📋 Requisitos:
          - PHP 8.1+
          - MySQL 5.7+ ou MariaDB 10.2+
          - Extensões: zip, curl, mbstring, openssl, pdo_mysql
          - Acesso à internet (para download do gestor + TailwindCSS CDN)
          
          ### 🎯 Funcionalidades do Instalador:
          - ✅ Validação de requisitos do sistema
          - ✅ Download automático do gestor v2.2.x+
          - ✅ Configuração automática do banco de dados
          - ✅ Migrations framework_css aplicadas automaticamente
          - ✅ Geração de chaves de segurança
          - ✅ Configuração de domínio e usuário admin
          - ✅ Preparação sistema de preview
          - ✅ Cleanup automático pós-instalação
          
          ### 🌐 Ambientes Suportados:
          - Hosting compartilhado (cPanel/Plesk)
          - VPS/Servidor dedicado
          - Desenvolvimento local (XAMPP/WAMP/MAMP)
          - Containers Docker
          
          ### 🚀 Compatibilidade com Gestor v2.2.x:
          - ✅ **Sistema Multilíngue**: Interface completa pt-br/en com seletor administrativo
          - ✅ **Plugins V2**: Arquitetura moderna com detecção dinâmica
          - ✅ **Templates Automatizados**: Scripts padronizados para desenvolvimento
          - ✅ **Rastreio de Origem**: Injeção automática de slug em tabelas
          - ✅ **Resolução Dinâmica**: Environment.json dinâmico e robusto
          - ✅ **IDs Textuais**: Migração completa para formato textual
          - ✅ **Cross-Platform**: Compatibilidade universal de scripts
          - ✅ **Seletor de Idioma**: Interface administrativa para configuração multilíngue
          - ✅ **Template .env Corrigido**: Valor padrão pt-br para LANGUAGE_DEFAULT
          - ✅ **Instalador Bilíngue**: Suporte completo à seleção de idioma
          
          ### 📊 Melhorias de Robustez:
          - ✅ **Charset Universal**: UTF-8/utf8mb4 em todas operações
          - ✅ **Error Handling**: Tratamento robusto de erros SQL
          - ✅ **Path Detection**: Detecção automática de caminhos e URLs
          - ✅ **Permission Fixes**: Ajustes automáticos de permissões
          - ✅ **Cross-Platform**: Funcionamento Windows/Linux/macOS
        draft: false
        prerelease: false
        files: instalador.zip
